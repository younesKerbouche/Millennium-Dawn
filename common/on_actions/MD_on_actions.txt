# Author(s): Angriest Bird
on_actions = {
	on_weekly = {
		effect = {
			worker_requirements_variable_gdpc_converging = yes

			missile_ui_update = yes

			microchip_update = yes
			composite_update = yes

			# Update money system right before adjusting weekly value
			ingame_update_setup = yes
			calculate_energy_load_sharing = yes
			nuclear_reactor_fuel_consumption = yes

			# Remove weekly rate from treasury
			if = { limit = { has_country_flag = int_reinvestment_flag }
				add_to_variable = { int_investments = int_investments_rate }
			}

			# No longer subject stop paying for subsidies
			if = { limit = { NOT = { check_variable = { subject_subsidization^0 = 0 } } }
				for_each_scope_loop = {
					array = subject_subsidization
					if = {
						limit = {
							OR = {
								NOT = { country_exists = THIS }
								NOT = { is_subject_of = PREV }
							}
						}
						if = {
							limit = { is_debug = yes }
							log = "[GetDateText]: [PREV.GetName]: Subject Subsidization from [PREV.GetName] to [THIS.GetName] has ended."
						}
						set_country_flag = { flag = canceled_overlord_subsidies_@PREV value = 1 days = 30 }
						# Clear the data
						clr_country_flag = overlord_is_subsidizing_us_@PREV
						clr_country_flag = overlord_subsidies
						remove_ideas = idea_overlord_subsidies
						ingame_update_setup = yes
						PREV = {
							set_country_flag = { flag = canceled_overlord_subsidies_@PREV value = 1 days = 30 }
							clr_country_flag = overlord_is_subsidizing_us_@PREV
							remove_from_array = { subject_subsidization = PREV.id }
							ingame_update_setup = yes
						}
					}
				}
			}

			if = { limit = { NOT = { has_country_flag = disabled_economic_system } }
				# Pay down debt automatically this weekly tick
				if = {
					limit = {
						has_country_flag = automatically_pay_off_debt_enabled
						check_variable = { treasury_rate > 0 }
						check_variable = { debt > 0 }
					}
					set_temp_variable = { treasury_rate_debt_payment = treasury_rate }
					multiply_temp_variable = { treasury_rate_debt_payment = 0.25 }
					subtract_from_variable = { debt = treasury_rate_debt_payment }

					if = {
						limit = { check_variable = { debt < 0.001 } }
						set_variable = { debt = 0 }
						clr_country_flag = automatically_pay_off_debt_enabled
					}
				}

				set_temp_variable = { treasury_rate_gain = treasury_rate }
				subtract_from_temp_variable = { treasury_rate_gain = treasury_rate_debt_payment }

				add_to_variable = { treasury = treasury_rate_gain }
				#Automated taking debt - has calculate_interest_rate at the end
				automated_debt_taker = yes
			}

			if = { limit = { is_ai = yes }
				# Initialize the Investment Pulse for this Week
				if = {
					limit = {
						check_variable = { interest_rate < 8.000 }
						OR = {
							has_idea = regional_power
							has_idea = large_power
							has_idea = great_power
							has_idea = superpower
						}
					}
					if = {
						limit = { NOT = { has_country_flag = investment_targets_are_set_up } }
						yearly_investment_targets_routine = yes
					}

					# Check whether the larger nation has an investment target in scope 0
					if = { limit = { NOT = { check_variable = { investment_targets^0 = 0 } } }
						country_event = AC_event.500
					}
				}

				# Update Operation AI - Vanilla mechanic
				if = {
					limit = {
						has_intelligence_agency = yes
					}
					update_operation_ai = yes
				}
			}

			# European Union Checks
			# FIXME: This needs to be reworked to not do this. I am not sure why this is still here
			if = { limit = { NOT = { has_global_flag = GAME_RULE_eu_disabled } }
				### POTEF election polls
				if = {
					limit = {
						has_global_flag = european_federation
						has_idea = EUU_monitor
						any_of_scopes = {
							array = global.EU_potential
							has_active_mission = EU_POTEF_election_campaign
						}
					}
					if = { limit = { is_debug = yes }
						log = "[GetDateText]: [ROOT.GetName]: on_weekly POTEF_election"
					}
					POTEF_election = yes
				}
			}

			# Cancel Invalid Projects
			if = { limit = { check_variable = { active_projects > 0 } }
				# Project loop.
				for_each_loop = { array = project_array

					if = { limit = { check_variable = { v < 0 } }

						set_variable = { project_type = i }

						if = {
							limit = {
								OR = {
									CONTROLLER = { has_war_with = ROOT } # target state controller at war with project owner
									var:v = { NOT = { investment_building_slot_available = yes } } # building slot unavailable in target state
								}
							}

							set_variable = { project = i }
							log = "AC Project Deletion - [GetDate] [This.GetTag] - on_weekly - deleted invalid project [?project] in [?project_array^project] [?project_array^project.GetName] [?project_array^project.GetName]"
							end_project = yes
						}
					}
				}

				clear_variable = project_type
			}

			if = { limit = { is_in_array = { global.ct_states = THIS } }
				if = {
					limit = {
						has_country_flag = jihadist_uprising_imminent
					}
					country_event = { id = terror.14 }
				}
			}

			# Arab Spring
			if = { limit = { has_country_flag = arab_spring_active }
				if = {
					limit = {
						has_country_flag = arab_spring_military_deployed
					}
					random_list = {
						33 = {
							modifier = {
								factor = 0
								check_variable = { the_military_opinion > 50 }
							}
							country_event = { id = arab_spring.7 days = 3 }
						}
						33 = {
							country_event = { id = arab_spring.8 days = 3 }
						}
						33 = { }
					}
				}
			}

			if = {
				limit = {
					has_global_flag = NATO_CSTO_treaty_ratified
					NOT = { has_global_flag = NATO_CSTO_treaty_adandoned }
				}

				NATO_CSTO_calculate_number_of_batallions = yes
			}
		}
	}

	#ROOT is winner #FROM gets annexed - For civil wars on_civil_war_end is also fired
	on_annex = {
		effect = {
			if = {
				limit = {
					ROOT = { original_tag = ARM }
					FROM = { original_tag = GEO }
				}
				ROOT = {
					add_ideas = ARM_GEO_religion_problem
					add_ideas = ARM_GEO_language
				}
			}
			if = {
				limit = {
					ROOT = { original_tag = ARM }
					FROM = { original_tag = AZE }
				}
				ROOT = {
					add_ideas = ARM_AZE_small_people
				}
			}
			if = {
				limit = {
					ROOT = { original_tag = CAN }
					FROM = { original_tag = QUE }
				}
				# return cores to CAN
				760 = { add_core_of = CAN }
				761 = { add_core_of = CAN }
				762 = { add_core_of = CAN }
				1159 = { add_core_of = CAN }
				1160 = { add_core_of = CAN }
			}
			if = {
				limit = { NOT = { has_global_flag = GAME_RULE_eu_disabled } }
				if = { limit = { FROM = { has_idea = EU_member } }
					log = "[GetDateText]: [ROOT.GetName]: on_annex EU Member"
					meta_effect = {
						text = {
							every_country = {
								limit = { has_idea = EU_member }
								clr_country_flag = focus_[EUXXX]_EP_agenda
								clr_country_flag = focus_on_EP_agenda
								clr_country_flag = [PG_X]_influence
								clr_country_flag = influence_PG
								clr_global_flag_PG_X_support = yes
								reset_MEP_support_party_x = yes
								set_variable = { global.active_MEP_Support = 0 }
								set_variable = { global.pass_vote_mission_ender = 0 }
								set_variable = { global.current_active_agenda_disp = 0 }
								clr_global_flag = focus_[index]_QMV_voted
								clr_global_flag = EU_qualified_majority_voting
								set_variable = { global.current_active_vote_disp = 0 }
								set_variable = { global.EUXXX_council_agenda = global.current_active_vote_disp }
								set_variable = { global.EU_active_vote_yes = 0 }
								set_variable = { global.EU_active_vote_no = 0 }
								clear_array = global.EU_active_vote_supporters
								clear_array = global.EU_active_vote_rejecters
								EU_emergency_vote_clear = yes
								set_variable = { global.EUU_recently_failed_vote = -1 }
							}
							FROM = { leaving_EU = yes }
						}

						EUXXX = "[EUXXX_EP_agenda]"
						PG_X = "[PG_X_influence]"
					}
					every_country = { limit = { has_idea = EU_member }
						remove_mission = EU_parliament_focus_EUXXX_approve_timer
						remove_mission = EU_voting_mission_focus_EUXXX_QMV_result_timer
					}
					every_country = { limit = { has_idea = EU_commission_president }
						remove_mission = EU_parliament_focus_EUXXX_approve
						remove_mission = EU_voting_mission_focus_EUXXX_QMV_result
					}
				}
				if = { limit = { FROM = { has_idea = EUU_monitor } }
					log = "[GetDateText]: [ROOT.GetName]: on_annex EUU_monitor change"
					random_country = {
						limit = {
							is_EU_potential = yes
							is_ai = yes
						}
						add_ideas = EUU_monitor
						activate_mission = EU_update_vars_mission
						activate_mission = EU_clear_voting_mission
					}
				}
			}

			EDU_learn_to_annex_your_neighbours = yes # LITERACY RATE STUFF

			# Grab your Nuclear Reactor Enrichment Facilities
			add_to_variable = { ROOT.enrichment_facilities = FROM.enrichment_facilities }

			every_country = {
				limit = { check_variable = { auto_influence_array^num > 0 } }
				set_temp_variable = { scoped_nation = THIS.id }
				for_each_loop = {
					array = auto_influence_array
					index = i
					value = v

					# Clears Auto Influencer Who No Longer Exists
					if = { limit = { var:auto_influence_array^i = { exists = no } }
						var:auto_influence_array^i = {
							var:scoped_nation = {
								remove_auto_influencer_request = yes
								update_auto_influence_array = yes
								update_dirty_influence_var = yes
							}
						}
					}
				}
			}

			# Remove Annexed Nation from Influence Arrays
			every_country = {
				limit = { is_in_array = { influence_array = FROM.id } }
				recalculate_influence = yes
			}

			FROM = {
				# projects
				# remove all projects by the annexed country
				if = { limit = { check_variable = { active_projects > 0 } }

					for_each_loop = {
						array = project_array

						if = { limit = { check_variable = { v < 0 } }

							set_variable = { project = i }
							end_project = yes
						}
					}
				}
			}
		}
	}

	on_peaceconference_ended = {
		effect = {
			if = {
				limit = {
					ROOT = { original_tag = ARM }
					FROM = { original_tag = TUR }
				}
				ROOT = { add_ideas = ARM_turkish_peasants }
			}
			if = {
				limit = {
					ROOT = { original_tag = USA }
					FROM = {
						original_tag = IRQ
						is_subject_of = USA
					}
				}
				set_global_flag = success_of_operation_iraqi_freedom
			}
			if = {
				limit = {
					IRQ = { has_completed_focus = IRQ_king_of_the_animal_kingdom }
					ROOT = { original_tag = SAU }
				}
				SAU = {
					release = ARA
					if = {
						limit = { has_global_flag = GAME_RULE_allow_colored_puppets }
						set_autonomy = {
							target = ARA
							autonomy_state = autonomy_puppet_state_colored
						}
					}
					else = {
						set_autonomy = {
							target = ARA
							autonomy_state = autonomy_puppet_state
						}
					}
				}
			}

			# Achievements
			if = {
				limit = {
					ROOT = { original_tag = LBA }
					FROM = { original_tag = EGY }
				}
				ROOT = { set_country_flag = ribbon_libya_victory_over_egypt }
			}
			if = {
				limit = {
					ROOT = { original_tag = LBA }
					FROM = { original_tag = CHA }
				}
				ROOT = { set_country_flag = ribbon_libya_victory_over_chad }
			}

			# Public War Weariness
			if = { limit = { NOT = { has_global_flag = GAME_RULE_disable_anti_bully } }
				if = {
					limit = {
						ROOT = {
							has_an_AB_war = no
							has_war = no
							has_dynamic_modifier = { modifier = public_war_weariness_effect }
						}
					}
					ROOT = {
						remove_dynamic_modifier = { modifier = public_war_weariness_effect }
						clear_variable = anti_bully_wars
						clear_variable = penalty_factor
						clear_variable = war_support_factor_var
					}
				}
				if = {
					limit = {
						FROM = {
							has_an_AB_war = no
							has_war = no
							has_dynamic_modifier = { modifier = public_war_weariness_effect }
						}
					}
					FROM = {
						remove_dynamic_modifier = { modifier = public_war_weariness_effect }
						clear_variable = anti_bully_wars
						clear_variable = penalty_factor
						clear_variable = war_support_factor_var
					}
				}
			}
		}
	}

	on_monthly = {
		effect = {
			# Triggers for one nation
			if = { limit = { NOT = { has_global_flag = on_monthly_done } }
				# Jan = 1, Feb = 2, March = 3, April = 4, May = 5, June = 6, July = 7
				# Aug = 8, Sep = 9, Oct = 10, Nov = 11, Dec = 12
				if = { limit = { check_variable = { global.month < 12 } }
					add_to_variable = { global.month = 1 }
				}
				else = {
					set_variable = { global.month = 1 }
				}
				set_temp_variable = { every_other_month = global.month }
				modulo_temp_variable = { every_other_month = 2 }

				if = {
					limit = { NOT = { has_global_flag = GAME_RULE_eu_disabled } }
					random_country = {
						limit = { has_idea = EU_member NOT = { has_global_flag = EU_gdp_updated } }
						set_EU_gdp = yes
						set_global_flag = { flag = EU_gdp_updated value = 1 }
					}
				}

				calculate_average_world_productivity = yes

				# National Updates:
				set_power_ranking_ideas_for_every_country = yes

				# Trigger Events for this year
				if = { limit = { check_variable = { global.month = 1 } }
					if = { limit = { is_debug = yes }
						log = "[GetDateText]: [THIS.GetName]: Run the On Yearly Monthly Check"
					}

					state_init_setup = yes

					every_country = {
						if = {
							limit = {
								is_ai = yes
								OR = {
									has_idea = regional_power
									has_idea = large_power
									has_idea = great_power
									has_idea = superpower
								}
							}

							yearly_investment_targets_routine = yes
						}

						if = {
							limit = {
								OR = {
									has_idea = low_level_of_aids
									has_idea = rising_level_of_aids
									has_idea = high_level_of_aids
									has_idea = very_high_level_of_aids
									has_idea = critical_level_of_aids
								}
							}
							if = { limit = { has_idea = health_01 }
								random_list = {
									50 = {
										country_event = { id = AIDS_events.1 }
									}
									50 = {
										country_event = { id = AIDS_events.2 }
									}
									0 = {
										country_event = { id = AIDS_events.3 }
									}
								}
							}
							else_if = { limit = { has_idea = health_02 }
								random_list = {
									40 = {
										country_event = { id = AIDS_events.1 }
									}
									50 = {
										country_event = { id = AIDS_events.2 }
									}
									10 = {
										country_event = { id = AIDS_events.3 }
									}
								}
							}
							else_if = { limit = { has_idea = health_03 }
								random_list = {
									30 = {
										country_event = { id = AIDS_events.1 }
									}
									50 = {
										country_event = { id = AIDS_events.2 }
									}
									20 = {
										country_event = { id = AIDS_events.3 }
									}
								}
							}
							else_if = { limit = { has_idea = health_04 }
								random_list = {
									20 = {
										country_event = { id = AIDS_events.1 }
									}
									50 = {
										country_event = { id = AIDS_events.2 }
									}
									30 = {
										country_event = { id = AIDS_events.3 }
									}
								}
							}
							else_if = { limit = { has_idea = health_05 }
								random_list = {
									10 = {
										country_event = { id = AIDS_events.1 }
									}
									50 = {
										country_event = { id = AIDS_events.2 }
									}
									40 = {
										country_event = { id = AIDS_events.3 }
									}
								}
							}
							else_if = { limit = { has_idea = health_06 }
								random_list = {
									0 = {
										country_event = { id = AIDS_events.1 }
									}
									50 = {
										country_event = { id = AIDS_events.2 }
									}
									50 = {
										country_event = { id = AIDS_events.3 }
									}
								}
							}
						}
						if = { limit = { NOT = { has_dlc = "La Resistance" } }
							random_list = {
								90 = {

								}
								10 = {
									modifier = {
										factor = 1.30
										has_idea = robust_cyber_security_infrastructure
									}
									country_event = cyber.1
								}
							}
						}
						# Reduce the Printing Money Var
						if = { limit = { check_variable = { printing_money_var > 0 } }
							subtract_from_variable = { printing_money_var = 1 }
						}

						if = { limit = { NOT = { check_variable = { influence_targets^0 = 0 } } }
							country_event = influence.500
						}
					}

					if = {
						limit = { NOT = { has_global_flag = yearly_export_tracker } }

						set_global_flag = { flag = yearly_export_tracker value = 1 days = 365 }
						yearly_global_export_normalization = yes
					}

					# Execute and Start the Yearly ETD Events
					if = { limit = { is_debug = yes }
						log = "[GetDateText]: [THIS.GetName]: Triggering [?global.year] events"
					}
					meta_effect = {
						text = {
							trigger_year_[year]_events = yes
						}
						year = "[?global.year]"
					}
				}

				# Counter Terror System
				if = { limit = { check_variable = { global.month = 6 } }
					random_scope_in_array = {
						array = global.ct_states
						limit = {
							is_in_array = { global.ct_states = THIS }
							no_jihadist_government = yes
							has_country_flag = threat_level_critical
							NOT = {
								tag = ROJ
								tag = KUR
								tag = PUK
								if = {
									limit = { country_exists = SYR }
									tag = FSA
								}
								if = {
									limit = { country_exists = YEM }
									tag = HOU
								}
							}
							if = {
								limit = {
									OR = {
										tag = SYR
										tag = FSA
									}
								}
								NOT = { country_exists = NUS }
							}
							if = {
								limit = {
									OR = {
										tag = HOU
										tag = YEM
									}
								}
								NOT = { country_exists = AQY }
							}
							if = {
								limit = {
									tag = IRQ
								}
								NOT = { country_exists = ISI }
							}
							if = {
								limit = {
									tag = SOM
								}
								NOT = { country_exists = SHB }
							}
							if = {
								limit = {
									tag = AFG
								}
								NOT = { country_exists = TAL }
							}
							NOT = { has_country_flag = jihadist_uprising_imminent }
							NOT = {
								any_home_area_neighbor_country = {
									OR = {
										has_country_flag = jihadist_uprising_imminent
										has_civil_war = yes
									}
								}
							}
						}
						country_event = { id = terror.12 random_days = 50 }
					}
					random_scope_in_array = {
						array = global.ct_states
						limit = {
							no_jihadist_government = yes
							has_country_flag = threat_level_critical
							if = {
								limit = {
									OR = {
										tag = SYR
										tag = FSA
										tag = ROJ
									}
								}
								NOT = { country_exists = NUS }
							}
							if = {
								limit = {
									OR = {
										tag = HOU
										tag = YEM
									}
								}
								NOT = { country_exists = AQY }
							}
							if = {
								limit = {
									OR = {
										tag = KUR
										tag = PUK
										tag = IRQ
									}
								}
								NOT = { country_exists = ISI }
							}
							if = {
								limit = {
									tag = SOM
								}
								NOT = { country_exists = SHB }
							}
							if = {
								limit = {
									tag = AFG
								}
								NOT = { country_exists = TAL }
							}
							has_country_flag = jihadist_uprising_imminent
							NOT = {
								any_home_area_neighbor_country = {
									OR = {
										has_country_flag = jihadist_uprising_imminent
										has_civil_war = yes
									}
								}
							}
						}
						country_event = { id = terror.13 random_days = 50 }
					}
					update_international_system_gui = yes
				}

				# Calculate the Migrant Trigger
				if = { limit = { NOT = { has_global_flag = EUU_migrant_crisis_triggered } }
					set_temp_variable = { total_population_refugees = 0 }
					every_country = {
						limit = {
							OR = {
								is_african_nation = yes
								is_middle_eastern_nation = yes
							}
							OR = {
								has_war = yes
								has_civil_war = yes
								salafist_caliphate_are_in_power = yes
							}
						}
						set_temp_variable = { population_refugees = population_total }
						multiply_temp_variable = { population_refugees = 0.025 }
						add_to_temp_variable = { PREV.total_population_refugees = population_refugees }
					}

					if = { limit = { check_variable = { total_population_refugees > 65 } }
						set_global_flag = EUU_migrant_crisis_triggered
						if = {
							limit = {
								any_of_scopes = {
									array = global.EU_member
									is_ai = no
								}
							}
							random_scope_in_array = {
								array = global.EU_member
								limit = { is_ai = no }

								country_event = { id = EUevent.22 }
							}
						}
						else = {
							random_scope_in_array = {
								array = global.EU_member
								country_event = { id = EUevent.22 }
							}
						}
					}
				}

				random_renewable_variable_calculation = yes

				# Monthly Single Fire Check
				every_country = {
					recalculate_party = yes
					ai_update_build_units = yes
					recalculate_law_desires = yes
					update_neighbors_effects = yes
					update_auto_influence_array = yes

					civilian_microchip_consumption = yes

					# AGRI SHIT
					AGRI_plow_the_fields = yes
					# LITERACY STUFF
					EDU_annual_pulse_for_learning_stuff = yes
					# Tick Internal Factions
					monthly_tick_internal_factions_opinion = yes

					# Space
					# INFO: This was readded back to the monthly tick due to the nature of the content.
					# tick speeds and otherwise should not be harmed.
					update_space_system_values = yes

					# Months at War Calculation
					if = {
						limit = { has_war = yes }
						add_to_variable = { months_at_war = 1 }
					}
					else = {
						set_variable = { months_at_war = 0 }
					}

					# # Check for Every Other Month
					if = {
						limit = {
							check_variable = { every_other_month = 1 }
							is_in_array = { global.ct_states = THIS.id }
						}
						if = {
							limit = {
								no_jihadist_government = yes
							}
							# Possibility of domestic terror attack - civilian
							if = {
								limit = {
									OR = {
										has_country_flag = threat_level_low
										has_country_flag = threat_level_moderate
										has_country_flag = threat_level_substantial
										has_country_flag = threat_level_severe
										has_country_flag = threat_level_critical
									}
								}
								random_list = {
									1 = { #terror attack planned
										random_list = {
											50 = { #foiled
												country_event = { id = terror.3 days = 15 random_hours = 45 }
											}
											50 = { #not foiled
												random_list = {
													33 = {
														set_country_flag = government_targeted
														country_event = { id = terror.4 days = 30 random_hours = 2400 }
													}
													33 = {
														set_country_flag = shia_targeted
														country_event = { id = terror.4 days = 30 random_hours = 2400 }
													}
													33 = {
														set_country_flag = church_targeted
														country_event = { id = terror.4 days = 30 random_hours = 2400 }
													}
												}
												modifier = {
													factor = 1.1
													has_idea = police_04
												}
												modifier = {
													factor = 1.2
													has_idea = police_03
												}
												modifier = {
													factor = 1.3
													has_idea = police_02
												}
												modifier = {
													factor = 1.4
													has_idea = police_01
												}
											}
										}
										modifier = {
											factor = 2
											has_country_flag = threat_level_moderate
										}
										modifier = {
											factor = 3
											has_country_flag = threat_level_substantial
										}
										modifier = {
											factor = 6
											has_country_flag = threat_level_severe
										}
										modifier = {
											factor = 10
											has_country_flag = threat_level_critical
										}
									}
									99 = {
									}
								}
							}
							# Possibility of domestic terror attack - military
							if = {
								limit = {
									OR = {
										has_country_flag = threat_level_severe
										has_country_flag = threat_level_critical
									}
								}
								random_list = {
									1 = { #terror attack planned
										random_list = {
											50 = { #foiled
												country_event = { id = terror.3 days = 30 random_hours = 2400 }
											}
											50 = { #not foiled
												country_event = { id = terror.5 days = 60 random_hours = 2400 }
												modifier = {
													factor = 1.1
													has_idea = police_04
												}
												modifier = {
													factor = 1.2
													has_idea = police_03
												}
												modifier = {
													factor = 1.3
													has_idea = police_02
												}
												modifier = {
													factor = 1.4
													has_idea = police_01
												}
											}
										}
										modifier = {
											factor = 2
											has_country_flag = threat_level_severe
										}
										modifier = {
											factor = 4
											has_country_flag = threat_level_critical
										}
									}
									99 = {
									}
								}
							}
							# Possibility of international terror attack - civilian
							if = {
								limit = {
									OR = {
										has_country_flag = threat_level_moderate
										has_country_flag = threat_level_substantial
										has_country_flag = threat_level_severe
										has_country_flag = threat_level_critical
									}
									is_full_state = yes
									any_country = {
										OR = {
											has_government = democratic
											has_government = communism
										}
										OR = {
											is_western_nation = yes
											is_East_Asia = yes
											original_tag = SOV
										}
										is_in_array = { ROOT.influence_array = THIS.id }
									}
								}
								random_list = {
									1 = { #terror attack planned
										random_list = {
											50 = { #foiled
												country_event = { id = terror.3 days = 15 random_hours = 2400 }
											}
											50 = { #not foiled
												news_event = { id = terror.6 days = 30 random_hours = 2400 }
												modifier = {
													factor = 1.1
													has_idea = police_04
												}
												modifier = {
													factor = 1.2
													has_idea = police_03
												}
												modifier = {
													factor = 1.3
													has_idea = police_02
												}
												modifier = {
													factor = 1.4
													has_idea = police_01
												}
											}
										}
										modifier = {
											factor = 1.5
											has_country_flag = threat_level_substantial
										}
										modifier = {
											factor = 2
											has_country_flag = threat_level_severe
										}
										modifier = {
											factor = 2.5
											has_country_flag = threat_level_critical
										}
									}
									99 = {
									}
								}
							}
							# Possibility of international terror attack - military
							if = {
								limit = {
									OR = {
										has_country_flag = threat_level_severe
										has_country_flag = threat_level_critical
									}
									is_full_state = yes
									any_country = {
										OR = {
											has_government = democratic
											has_government = communism
										}
										is_full_state = yes
										has_military_access_to = ROOT
									}
								}
								random_list = {
									1 = { #terror attack planned
										random_list = {
											50 = { #foiled
												country_event = { id = terror.3 days = 30 random_hours = 2400 }
											}
											50 = { #not foiled
												news_event = { id = terror.7 days = 60 random_hours = 2400 }
												modifier = {
													factor = 1.1
													has_idea = police_04
												}
												modifier = {
													factor = 1.2
													has_idea = police_03
												}
												modifier = {
													factor = 1.3
													has_idea = police_02
												}
												modifier = {
													factor = 1.4
													has_idea = police_01
												}
											}
										}
										modifier = {
											factor = 2
											has_country_flag = threat_level_critical
										}
									}
									99 = {
									}
								}
							}
							# # Possibility of jihadists crossing the border
							# TODO: This is expensive and needs to be either A: removed or B: optimized
							# if = {
							# 	limit = {
							# 		OR = {
							# 			has_country_flag = threat_level_severe
							# 			has_country_flag = threat_level_critical
							# 		}
							# 	}
							# 	every_neighbor_country = {
							# 		limit = {
							# 			no_jihadist_government = yes
							# 			is_in_array = { global.ct_states = THIS }
							# 		}
							# 		random_owned_state = {
							# 			limit = {
							# 				any_neighbor_state = {
							# 					is_owned_by = ROOT
							# 				}
							# 				NOT = { state = 175 }
							# 			}
							# 			set_temp_variable = { temp1 = THIS }
							# 		}
							# 		random_list = {
							# 			1 = {
							# 				country_event = { id = terror.8 days = 45 random_hours = 2400 }
							# 				modifier = {
							# 					factor = 5
							# 					ROOT = { has_country_flag = threat_level_critical }
							# 				}
							# 				modifier = {
							# 					factor = 0.5
							# 					divisions_in_state = {
							# 						size > 0
							# 						state = temp1
							# 					}
							# 				}
							# 				modifier = {
							# 					factor = 0.5
							# 					divisions_in_state = {
							# 						size > 1
							# 						state = temp1
							# 					}
							# 				}
							# 				modifier = {
							# 					factor = 0.5
							# 					divisions_in_state = {
							# 						size > 2
							# 						state = temp1
							# 					}
							# 				}
							# 				modifier = {
							# 					factor = 0.5
							# 					divisions_in_state = {
							# 						size > 3
							# 						state = temp1
							# 					}
							# 				}
							# 				modifier = {
							# 					factor = 0.5
							# 					divisions_in_state = {
							# 						size > 4
							# 						state = temp1
							# 					}
							# 				}
							# 			}
							# 			99 = {
							# 			}
							# 		}
							# 	}
							# }
						}
					}

					# Counter Terror Content
					# Radicalization increase
					if = { limit = { has_variable = social_conservatism_government }
						if = { limit = { check_variable = { social_conservatism_government < social_conservatism_society } }
							subtract_from_variable = { social_conservatism_society = 1 }
							clamp_variable = { var = social_conservatism_society min = social_conservatism_government max = 100 }

							if = {
								limit = {
									OR = {
										check_variable = { global.month = 4 }
										check_variable = { global.month = 8 }
										check_variable = { global.month = 12 }
									}
								}
								random_list = {
									50 = {
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 10 }
											check_variable = { social_conservatism_society > 10 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 20 }
											check_variable = { social_conservatism_society > 20 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 30 }
											check_variable = { social_conservatism_society > 30 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 40 }
											check_variable = { social_conservatism_society > 40 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 50 }
											check_variable = { social_conservatism_society > 50 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 60 }
											check_variable = { social_conservatism_society > 60 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 70 }
											check_variable = { social_conservatism_society > 70 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 80 }
											check_variable = { social_conservatism_society > 80 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government < 90 }
											check_variable = { social_conservatism_society > 90 }
										}
										country_event = { id = radicalization.1 random_hours = 24 }
									}
									50 = {

									}
								}
							}
						}

						if = { limit = { check_variable = { social_conservatism_government > social_conservatism_society } }
							add_to_variable = { social_conservatism_society = 1 }
							clamp_variable = { var = social_conservatism_society min = 0 max = social_conservatism_government }
							update_social_conservatism_idea = yes

							if = {
								limit = {
									OR = {
										check_variable = { global.month = 4 }
										check_variable = { global.month = 8 }
										check_variable = { global.month = 12 }
									}
								}
								random_list = {
									50 = {
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 10 }
											check_variable = { social_conservatism_society < 10 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 20 }
											check_variable = { social_conservatism_society < 20 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 30 }
											check_variable = { social_conservatism_society < 30 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 40 }
											check_variable = { social_conservatism_society < 40 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 50 }
											check_variable = { social_conservatism_society < 50 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 60 }
											check_variable = { social_conservatism_society < 60 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 70 }
											check_variable = { social_conservatism_society < 70 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 80 }
											check_variable = { social_conservatism_society < 80 }
										}
										modifier = {
											factor = 0.5
											check_variable = { social_conservatism_government > 90 }
											check_variable = { social_conservatism_society < 90 }
										}
										country_event = { id = radicalization.2 random_hours = 24 }
									}
									50 = {

									}
								}
							}
						}
					}

					if = { limit = { is_in_array = { global.ct_states = THIS } }
						if = { limit = { check_variable = { ct_training > 0 } }
							subtract_from_variable = { ct_training = 0.2 }
							clamp_variable = { var = ct_training min = 0 max = 10 }
						}

						# tri-monthly Radicalization Increase
						if = {
							limit = {
								check_variable = { party_pop_array^11 > 0 }
								OR = {
									check_variable = { global.month = 3 }
									check_variable = { global.month = 6 }
									check_variable = { global.month = 9 }
									check_variable = { global.month = 12 }
								}
							}
							set_temp_variable = { rad_change = party_pop_array^11 }
							multiply_temp_variable = { rad_change = 0.5 }
							modify_radicalization_effect = yes
						}

						if = {
							limit = {
								OR = {
									check_variable = { global.month = 4 }
									check_variable = { global.month = 8 }
									check_variable = { global.month = 12 }
								}
							}
							country_event = { id = radicalization.9 random_days = 10 }
							country_event = { id = radicalization.7 random_days = 10 }
						}
					}

					# Player only checks
					if = { limit = { is_ai = no }
						if = {
							limit = {
								any_of = {
									array = auto_influence_array
									NOT = { check_variable = { v = 0 } }
								}
							}
							set_variable = { nations_influenced = 0 }

							set_temp_variable = { percent_change = global.percent_change_value }
							set_temp_variable = { tag_index = THIS.id }
							for_each_loop = {
								array = auto_influence_array
								index = i
								value = v
								if = {
									limit = {
										NOT = { check_variable = { v = 0 } }
										var:auto_influence_array^i = { var:tag_index = { NOT = { has_country_flag = spread_influence@PREV } } }
										var:auto_influence_array^i = { exists = yes }
									}
									log = "[GetDateText]: [ROOT.GetName]: Index:[?i], Auto influencing [?var:auto_influence_array^i.GetName]"
									set_temp_variable = { influence_target = v }
									change_influence_percentage = yes
									var:tag_index = {
										add_to_variable = { nations_influenced = 1 }
									}
								}
								else = {
									log = "[GetDateText]: [ROOT.GetName]: Index:[?i], Auto influencing failed to influence on index [?i]"
								}
							}
							for_each_loop = {
								array = auto_influence_array
								index = i
								value = v
								if = { limit = { check_variable = { i < nations_influenced } }
									var:auto_influence_array^i = {
										ROOT = {
											if = { limit = { has_global_flag = GAME_RULE_spread_influence_14_days }
												set_country_flag = { flag = spread_influence@PREV value = 1 days = 14 }
											}
											if = { limit = { has_global_flag = GAME_RULE_spread_influence_60_days }
												set_country_flag = { flag = spread_influence@PREV value = 1 days = 60 }
											}
											if = { limit = { has_global_flag = GAME_RULE_spread_influence_30_days }
												set_country_flag = { flag = spread_influence@PREV value = 1 days = 30 }
											}
										}
									}
								}
							}
							update_dirty_influence_var = yes

							if = { limit = { NOT = { has_country_flag = disable_auto_influence_notification } }
								country_event = influence.54
							}
						}
						if = {
							limit = {
								has_political_power < -100
							}
							log = "[GetDateText]: [THIS.GetName]: Political Power is under -100. Clearing the auto-influence array"
							clear_array = auto_influence_array
							set_variable = { auto_influence_users = 0 }
							resize_array = { array = auto_influence_array value = 0 size = 10 } # ONLY 4 MORE SLOTS ARE AVAILABLE
							update_auto_influence_array = yes
							update_dirty_influence_var = yes
						}

						if = { limit = { NOT = { has_global_flag = GAME_RULE_gdp_graph_enabled } }
							gdp_graph_on_monthly = yes
							# its a bit bad thing to do it here, but we need to smooth out "bumps" in gdp graph
							# if gdp increases/drops by more then 5% in 1 month, take gdp value from 3 months back
							# and use it to "smoothe out" the values between current and 3 months old gdp
							if = {
								# atleast couple of months in the game
								limit = {
									check_variable = { current_gdp_graph_end > 2 }
								}

								set_temp_variable = { temp_index = current_gdp_graph_end }
								subtract_from_temp_variable = { temp_index = 1 }
								set_temp_variable = { old_gdp = gdp_array^temp_index }

								divide_temp_variable = { old_gdp = gdp_total }
								if = {
									limit = {
										OR = {
											check_variable = { old_gdp < 0.95 }
											check_variable = { old_gdp > 1.05 }
										}
									}

									correct_gdp_graph = yes
								}
							}
						}
					}
					else = {
						ai_weapon_dump = yes

						# used in strategies, instead of checking it directly there
						if = {
							limit = {
								has_war = no
								any_country = { has_wargoal_against = ROOT }
							}

							set_country_flag = { flag = someone_has_wargoal_against_this_flag value = 1 days = 100 }
						}

						if = {
							limit = {
								check_variable = { next_slot_from_gdp < 10 }
								NOT = { has_decision = gdp_gain_slot }
								NOT = { has_country_flag = gdp_gain_industry_slot_flag }
								check_variable = { gdp_total > GLOBAL.gdp_slot^next_slot_from_gdp }
							}
							set_country_flag = { flag = gdp_gain_industry_slot_flag value = 1 days = 240 }
							activate_decision = gdp_gain_slot
						}
						if = {
							limit = {
								check_variable = { next_slot_from_gdp_c < 7 }
								NOT = { has_decision = gdp_c_gain_slot }
								NOT = { has_country_flag = gdp_gain_developmental_size_flag }
								check_variable = { gdp_per_capita > GLOBAL.gdp_c_slot^next_slot_from_gdp_c }
							}
							set_country_flag = { flag = gdp_gain_developmental_size_flag value = 1 days = 240 }
							activate_decision = gdp_c_gain_slot
						}

						if = {
							limit = {
								# with god of war on
								has_game_rule = {
									rule = rule_god_of_war
									option = yes
								}
							}

							ai_add_xp = yes

							if = {
								limit = {
									# does not have player as ally
									NOT = {
										any_of = {
											array = allies
											is_ai = no
										}
									}
									# Either WT > 30 OR Player is the enemy
									OR = {
										threat > 0.3
										any_of = {
											array = enemies
											is_ai = no
										}
									}
								}

								ai_add_equipment = yes
								ai_spawn_units = yes
							}
						}
					}

					# If child soldier thing
					if = { limit = { has_idea = child_soldiers }
						add_to_variable = { child_soldiers = child_soldiers_recruitment }
					}

					# Open Borders Impact
					if = {
						limit = { has_idea = open_borders }
						add_to_variable = { months_at_open_borders = 0.03 }
					}
					if = {
						limit = { NOT = { has_idea = open_borders } }
						set_variable = { months_at_open_borders = 1 }
					}

					# EU Values Check Monthly
					if = { limit = { NOT = { has_global_flag = GAME_RULE_eu_disabled } }
						if = { limit = { is_in_array = { global.EU_potential = THIS.id } }
							check_breach_of_EU_value = yes
						}
					}

					calculate_expected_spending = yes
					apply_protest_effects = yes

					# Monthly Foreign Influence Tick
					if = { limit = { difficulty > 1 }
						set_temp_variable = { percent_change = global.rule_monthly_domestic_independence_gain_amount }
						add_to_temp_variable = { percent_change = modifier@foreign_influence_monthly_domestic_independence_gain_modifier }
						set_temp_variable = { temp_percentage_modifier = 1 }
						add_to_temp_variable = { temp_percentage_modifier = modifier@foreign_influence_monthly_domestic_independence_gain_factor }
						multiply_temp_variable = { percent_change = temp_percentage_modifier }
						change_domestic_influence_percentage = yes
					}

					# Muslim Brotherhood Stuff
					if = {
						limit = {
							NOT = { has_global_flag = GAME_RULE_disable_muslim_brotherhood }
							Is_Possible_Muslim_Brotherhood = yes
							NOT = {
								has_government = neutrality
								Is_Muslim_Brotherhood = yes
								has_country_flag = BROTHER_civil_war_has_started
							}
							has_elections = no
						}
						if = {
							limit = {
								has_idea = muslim_brotherhood_crackdown
								neutrality > 0.2
							}

							random_list = {
								25 = {
									# Brutality of Crackdown Backfires
									country_event = { id = brotherhood.7 }
								}
								25 = {
									# Muslim Brotherhood Terrorists Raid Prison
									country_event = { id = brotherhood.8 }
								}
								25 = {
									# Muslim Brotherhood Terror-Cell Dismantled
									country_event = { id = brotherhood.9 }
								}
								25 = {

								}
							}
						}

						# Muslim Brotherhood Protestors Demand Elections
						if = {
							limit = {
								NOT = { has_country_flag = recently_had_muslim_brotherhood_demanded_election }
								NOT = { has_idea = muslim_brotherhood_crackdown }
								neutrality > 0.35
							}
							random = {
								chance = 40
								country_event = { id = brotherhood.6 }
							}
						}

						# Muslim Brotherhood Insurgency Turns Civil War
						if = {
							limit = {
								has_idea = muslim_brotherhood_crackdown
								NOT = { has_war = yes }
								neutrality > 0.5
							}
							random = {
								chance = 35
								country_event = { id = brotherhood.10 }
							}
						}
					}

					# NATO Event
					if = { limit = { has_idea = NATO_member }
						if = {
							limit = {
								has_elections = no
								NOT = { has_government = fascism }
							}
							country_event = { id = NATO.17 random_days = 7 }
						}
					}

					# Arab Spring Monthly Tick
					if = {
						limit = {
							is_in_array = { global.arabic_countries = THIS.id }
							NOT = { has_country_flag = AS_arab_spring_completed } # DO NOT INCREMENT IF YOU HAVE COMPLETED THE ARAB SPRING MINI GAME
						}

						increment_arab_spring_strength = yes
					}

					productivity_growth_effect = yes
				}

				# Gulf Cooperation Council Unity Additions
				if = { limit = { threat > 0.25 }
					add_to_variable = { global.gcc_unity = 1 }
				}
				if = { limit = { threat > 0.50 }
					add_to_variable = { global.gcc_unity = 2 }
				}
				if = { limit = { threat > 0.75 }
					add_to_variable = { global.gcc_unity = 5 }
				}
				clamp_variable = { var = global.gcc_unity min = 0 max = 100 }

				## This section is just for the instance where someone just need to have it started
				if = { limit = { NOT = { has_global_flag = global_arab_spring_started } }
					random_country = {
						limit = {
							check_variable = { arab_spring > 199 }
							date > 2010.1.1
							NOT = { any_country = { has_country_flag = arab_spring_active } }
							NOT = { is_in_array = { ruling_party = 12 } }
							has_war = no
						}

						set_country_flag = arab_spring_active
						random_list = {
							90 = {
								modifier = {
									factor = 2
									has_elections = yes
									NOT = {
										has_idea = hybrid_regime_emerging
										has_idea = hybrid_regime_western
									}
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring < 200 }
								}
							}
							10 = {
								modifier = {
									factor = 1.25
									date > 2011.1.1
								}
								modifier = {
									factor = 1.5
									date > 2012.1.1
								}
								modifier = {
									factor = 1.75
									date > 2013.1.1
								}
								modifier = {
									factor = 2
									date > 2014.1.1
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring > 225 }
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring > 250 }
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring > 275 }
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring > 300 }
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring > 400 }
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring > 500 }
								}
								modifier = {
									factor = 2
									check_variable = { arab_spring > 600 }
								}
								country_event = { id = arab_spring.0 days = 1 random_days = 15 }
							}
						}
					}
				}

				if = {
					limit = { NOT = { has_global_flag = resource_prices_adjusted } }

					set_global_flag = { flag = resource_prices_adjusted value = 1 days = 10 }
					recalculate_resources_price = yes
					if = {
						limit = { is_debug = yes }
						log = "Current resource prices: steel = [?global.steel_price] rubber = [?global.rubber_price] oil = [?global.oil_price] alum = [?global.aluminium_price] tungsten = [?global.tungsten_price] chromium = [?global.chromium_price] Resource coeff = [?global.resource_gdp_coeff]"
					}
				}

				# On Monthly Flag:
				# Set this to 27 days to time out so that way February isn't missed
				set_global_flag = { flag = on_monthly_done value = 1 days = 27 }
				if = { limit = { is_debug = yes }
					log = "[GetDateText]: [THIS.GetName]: MD Monthly On_Action Triggered Month: [?global.month] Year: [?global.year]"
				}
			}
		}
	}
}
