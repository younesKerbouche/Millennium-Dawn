EH_drone_mission_calculations_effect = {
    # Drones bonus
    set_variable = { EH_drone_success_chance = EH_selected_drones_var }
    multiply_variable = { EH_drone_success_chance = 0.06 }

    # Air Intel bonus
    set_variable = { EH_temp_air_intel = air_intel@ALN }
    multiply_variable = { EH_temp_air_intel = 0.55 }
    add_to_variable = { EH_drone_success_chance = EH_temp_air_intel }

    # Failure chance
    set_variable = { EH_drone_failure_chance = 100 }
    subtract_from_variable = { EH_drone_failure_chance = EH_drone_success_chance }
}

EH_drone_mission_effect = {
    random_list = {
        EH_drone_success_chance = {
            # Success
            add_intel = {
                target = ALN
                army_intel = 15
                airforce_intel = 15
            }
            country_event = EH_focus_event.3
            set_country_flag = EH_country_succeeded_in_drone_mission_flag # Important further while recruiting scientists
            clear_variable = EH_drone_success_chance
            clear_variable = EH_drone_failure_chance
            clear_variable = EH_temp_air_intel

            set_temp_variable_to_random = {
                var = EH_temp_drones_lost
                max = EH_selected_drones_var
                integer = yes
            }
            add_ai_strategy = {
			    type = equipment_variant_production_factor
			    id = small_plane_suicide_airframe
			    value = -100
			}
        }
        EH_drone_failure_chance = {
            # Failure
            set_temp_variable = { EH_temp_drones_lost = EH_selected_drones_var }
            country_event = EH_focus_event.4
        }
    }
    multiply_temp_variable = { EH_temp_drones_lost = -1 }
    add_equipment_to_stockpile = {
        type = small_plane_suicide_airframe
        amount = EH_temp_drones_lost
    }
}

EH_calculate_research_sites_effects = {
    set_variable = { EH_research_sites_research_speed_factor_var = 0.01 }
    set_variable = { EH_research_sites_scientist_breakthrough_bonus_factor_var = 0.02 }
    set_variable = { EH_research_sites_scientist_research_bonus_factor_var = 0.025 }
    set_variable = { EH_research_sites_scientist_xp_gain_factor_var = 0.03 }
    multiply_variable = { EH_research_sites_research_speed_factor_var = EH_research_sites_constructed_var }
    multiply_variable = { EH_research_sites_scientist_breakthrough_bonus_factor_var = EH_research_sites_constructed_var }
    multiply_variable = { EH_research_sites_scientist_research_bonus_factor_var = EH_research_sites_constructed_var }
    multiply_variable = { EH_research_sites_scientist_xp_gain_factor_var = EH_research_sites_constructed_var }
}

EH_research_site_strike_effect = {
    set_temp_variable = { EH_temp_strike_success_chance = 80 }
    subtract_from_temp_variable = { EH_temp_strike_success_chance = EH_research_sites_protection_var }

    set_temp_variable = { EH_temp_strike_failure_chance = 100 }
    subtract_from_temp_variable = { EH_temp_strike_failure_chance = EH_temp_strike_success_chance }

    random_list = {
        EH_temp_strike_success_chance = {
            # Success
            set_country_flag = {
                flag = EH_research_sites_strike_cooldown_flag
                days = 21
                value = 1
            }
            subtract_from_variable = { EH_research_sites_constructed_var = 1 }
            clamp_variable = {
                var = EH_research_sites_constructed_var
                min = 0
            }
            EH_calculate_research_sites_effects = yes
            if = {
                limit = {
                    has_country_flag = EH_research_sites_disable_notifications_flag
                }
                add_manpower = -50
		        ALN = {
			        add_manpower = -120
		        }
		        add_breakthrough_progress = {
 			        specialization = specialization_land
  			        value = -0.15
		        }
            }
            else = {
                country_event = EH_focus_event.5
            }
            EH_research_site_scientist_survive_effect = yes
        }
        EH_temp_strike_failure_chance = {
            # Failure
            set_country_flag = {
                flag = EH_research_sites_strike_cooldown_flag
                days = 35
                value = 1
            }
            if = {
                limit = {
                    has_country_flag = EH_research_sites_disable_notifications_flag
                }
                add_manpower = -15
		        ALN = {
			        add_manpower = -240
		        }
            }
            else = {
                country_event = EH_focus_event.6
            }
        }
    }
}

EH_research_site_scientist_survive_effect = {
    set_temp_variable = { EH_temp_scientist_killed_chance = 40 }
    subtract_from_temp_variable = { EH_temp_scientist_killed_chance = EH_research_sites_scientist_protection_var }

    set_temp_variable = { EH_temp_scientist_survived_chance = 100 }
    subtract_from_temp_variable = { EH_temp_scientist_survived_chance = EH_temp_scientist_killed_chance }

    random_list = {
        EH_temp_scientist_killed_chance = {
            # Killed
            country_event = EH_focus_event.7
            while_loop_effect = {
                limit = {
                    NOT = {
                        has_country_flag = EH_research_sites_scientist_found_flag
                    }
                }
                set_temp_variable_to_random = {
                    var = EH_temp_var
                    min = 0
                    max = 5
                    integer = yes
                }
                if = {
                    limit = {
                        is_in_array = { EH_scientists_array = EH_temp_var }
                    }
                    set_variable = { EH_scientists_array^EH_temp_var = -1 }
                    set_country_flag = EH_research_sites_scientist_found_flag
                }
            }
            clr_country_flag = EH_research_sites_scientist_found_flag
        }
        EH_temp_scientist_survived_chance = {
            # Survived
            # Nothing happens
        }
    }
}

EH_modify_research_sites_prep_time_effect = {
    subtract_from_variable = { EH_research_sites_prep_time_var = EH_temp_research_sites_prep_time_var }
	custom_effect_tooltip = EH_research_sites_prep_time_shortened_TT
}

EH_research_sites_protection_increase = {
    add_to_variable = { EH_research_sites_protection_var = EH_temp_protection_increase }
    custom_effect_tooltip = EH_research_sites_protection_upgrade_installed_TT
}

EH_research_sites_scientist_protection_increase = {
    add_to_variable = { EH_research_sites_scientist_protection_var = EH_temp_research_sites_scientist_protection_increase }
    custom_effect_tooltip = EH_research_sites_scientist_protection_upgrade_installed_TT
}

EH_convergence_event_chain_effect = {
    random_country = {
        news_event = { id = EH_event.300 days = 1 random_days = 10 }
        news_event = { id = EH_event.301 days = 12 random_days = 7 }
        news_event = { id = EH_event.302 days = 23 random_days = 6 }
        news_event = { id = EH_event.303 days = 32 random_days = 6 }
        news_event = { id = EH_event.304 days = 41 random_days = 5 }
        news_event = { id = EH_event.305 days = 47 random_days = 5 }
        news_event = { id = EH_event.306 days = 55 random_days = 4 }
        news_event = { id = EH_event.307 days = 62 random_days = 4 }
        news_event = { id = EH_event.308 days = 68 }
        news_event = { id = EH_event.309 days = 70 }
    }
    random_country = {
        limit = {
            is_in_north_america = yes
        }
        country_event = { id = EH_event.401 days = 75 random_days = 5 }
        USN = {
            inherit_technology = PREV
        }
    }
}

EH_set_randallite_effect = {
    set_variable = { EH_randallite_stockpile = EH_total_randallite_var }
    subtract_from_variable = { EH_randallite_stockpile = modifier@randallite_resource_cost_modifier }

    set_variable = { EH_randallite_usage_var = EH_total_randallite_var }
    subtract_from_variable = { EH_randallite_usage_var = EH_randallite_stockpile }
}

EH_add_randallite_effect = {
	custom_effect_tooltip = EH_add_randallite_effect_tt
	add_to_variable = { EH_total_randallite_var = add_randallite }
}

EH_randallite_effects = {
    set_variable = { EH_randallite_productivity_var = 0.01 }
    set_variable = { EH_randallite_mech_production_speed_var = 0.004 }
    set_variable = { EH_randallite_resource_income_var = 0.006 }
    set_variable = { EH_randallite_industrial_capacity_var = 0.005 }
    set_variable = { EH_randallite_cic_construction_boost_var = 0.01 }

    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_randallite_productivity_var > 0 }
                check_variable = { EH_temp_randallite_productivity_var < 0 }
            }
        }
        add_to_variable = { EH_randallite_productivity_var = EH_temp_randallite_productivity_var }
        custom_effect_tooltip = EH_randallite_productivity_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_randallite_mech_production_speed_var > 0 }
                check_variable = { EH_temp_randallite_mech_production_speed_var < 0 }
            }
        }
        add_to_variable = { EH_randallite_mech_production_speed_var = EH_temp_randallite_mech_production_speed_var }
        custom_effect_tooltip = EH_randallite_mech_production_speed_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_randallite_resource_income_var > 0 }
                check_variable = { EH_temp_randallite_resource_income_var < 0 }
            }
        }
        add_to_variable = { EH_randallite_resource_income_var = EH_temp_randallite_resource_income_var }
        custom_effect_tooltip = EH_randallite_resource_income_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_randallite_industrial_capacity_var > 0 }
                check_variable = { EH_temp_randallite_industrial_capacity_var < 0 }
            }
        }
        add_to_variable = { EH_randallite_industrial_capacity_var = EH_temp_randallite_industrial_capacity_var }
        custom_effect_tooltip = EH_randallite_industrial_capacity_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_randallite_cic_construction_boost_var > 0 }
                check_variable = { EH_temp_randallite_cic_construction_boost_var < 0 }
            }
        }
        add_to_variable = { EH_randallite_cic_construction_boost_var = EH_temp_randallite_cic_construction_boost_var }
        custom_effect_tooltip = EH_randallite_cic_construction_boost_modified_TT
    }

    multiply_variable = { EH_randallite_productivity_var = EH_randallite_stockpile }
    multiply_variable = { EH_randallite_mech_production_speed_var = EH_randallite_stockpile }
    multiply_variable = { EH_randallite_resource_income_var = EH_randallite_stockpile }
    multiply_variable = { EH_randallite_industrial_capacity_var = EH_randallite_stockpile }
    multiply_variable = { EH_randallite_cic_construction_boost_var = EH_randallite_stockpile }
}

EH_battlefield_adaptation_effect = {
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_army_morale_factor_var3 > 0 }
                check_variable = { EH_temp_army_morale_factor_var3 < 0 }
            }
        }
        add_to_variable = { EH_army_morale_factor_var3 = EH_temp_army_morale_factor_var3 }
        custom_effect_tooltip = EH_battlefield_adaptation_army_morale_factor_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_army_strength_factor_var3 > 0 }
                check_variable = { EH_temp_army_strength_factor_var3 < 0 }
            }
        }
        add_to_variable = { EH_army_strength_factor_var3 = EH_temp_army_strength_factor_var3 }
        custom_effect_tooltip = EH_battlefield_adaptation_army_strength_factor_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_research_speed_factor_var3 > 0 }
                check_variable = { EH_temp_research_speed_factor_var3 < 0 }
            }
        }
        add_to_variable = { EH_research_speed_factor_var3 = EH_temp_research_speed_factor_var3 }
        custom_effect_tooltip = EH_battlefield_adaptation_research_speed_factor_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_production_lack_of_resource_penalty_factor_var3 > 0 }
                check_variable = { EH_temp_production_lack_of_resource_penalty_factor_var3 < 0 }
            }
        }
        add_to_variable = { EH_production_lack_of_resource_penalty_factor_var3 = EH_temp_production_lack_of_resource_penalty_factor_var3 }
        custom_effect_tooltip = EH_battlefield_adaptation_production_lack_of_resource_penalty_factor_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_training_time_factor_var3 > 0 }
                check_variable = { EH_temp_training_time_factor_var3 < 0 }
            }
        }
        add_to_variable = { EH_training_time_factor_var3 = EH_temp_training_time_factor_var3 }
        custom_effect_tooltip = EH_battlefield_adaptation_training_time_factor_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_planning_speed_var3 > 0 }
                check_variable = { EH_temp_planning_speed_var3 < 0 }
            }
        }
        add_to_variable = { EH_planning_speed_var3 = EH_temp_planning_speed_var3 }
        custom_effect_tooltip = EH_battlefield_adaptation_planning_speed_modified_TT
    }
    if = {
        limit = {
            OR = {
                check_variable = { EH_temp_max_planning_factor_var3 > 0 }
                check_variable = { EH_temp_max_planning_factor_var3 < 0 }
            }
        }
        add_to_variable = { EH_max_planning_factor_var3 = EH_temp_max_planning_factor_var3 }
        custom_effect_tooltip = EH_battlefield_adaptation_max_planning_factor_modified_TT
    }
}

EH_chimera_portal_1_created_effect = {
	if = {
		limit = {
			NOT = {
				has_global_flag = chimera_portal_1_created
			}
		}
		create_entity = {
			entity = portal_chimera_entity
			id = 9991
			x = 1
			y = 1
			z = 1
			province = 14126
			rotation = 1.0
			scale = 1.0
			min_zoom = 150.0
			visible = EH_scenario_enabled
		}
		591 = {
			add_dynamic_modifier = { modifier = EH_portal_presence_modifier }
			set_state_flag = EH_state_with_portal
		}
		set_global_flag = chimera_portal_1_created
	}
}

EH_chimera_portal_234_created_effect = {
	if = {
		limit = {
			NOT = {
				has_global_flag = chimera_portal_234_created
			}
		}
		create_entity = {
			entity = portal_chimera_entity
			id = 9992
			x = 1
			y = 1
			z = 1
			province = 11009
			rotation = 1.0
			scale = 1.0
			min_zoom = 150.0
			visible = EH_scenario_enabled
		}
		create_entity = {
			entity = portal_chimera_entity
			id = 9993
			x = 1
			y = 1
			z = 1
			province = 13831
			rotation = 1.0
			scale = 1.0
			min_zoom = 150.0
			visible = EH_scenario_enabled
		}
		create_entity = {
			entity = portal_chimera_entity
			id = 9994
			x = 1
			y = 1
			z = 1
			province = 15079
			rotation = 1.0
			scale = 1.0
			min_zoom = 150.0
			visible = EH_scenario_enabled
		}
		234 = {
			add_dynamic_modifier = { modifier = EH_portal_presence_modifier }
			set_state_flag = EH_state_with_portal
		}
		814 = {
			add_dynamic_modifier = { modifier = EH_portal_presence_modifier }
			set_state_flag = EH_state_with_portal
		}
		457 = {
			add_dynamic_modifier = { modifier = EH_portal_presence_modifier }
			set_state_flag = EH_state_with_portal
		}
		set_global_flag = chimera_portal_234_created
	}
}

EH_chimera_portal_destroyed_effect = {
	var:target_state = {
		set_state_flag = EH_state_with_destroyed_portal
	}
	if = {
		limit = {
			591 = {
				has_state_flag = EH_state_with_destroyed_portal
				has_state_flag = EH_state_with_portal
			}
		}
		destroy_entity = 9991
		damage_units = {
			region = 188
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 144
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 146
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 161
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 153
			limit = { original_tag = ALN }
			damage = 1
		}
		591 = {
			clr_state_flag = EH_state_with_destroyed_portal
			clr_state_flag = EH_state_with_portal
		}
	}
	if = {
		limit = {
			457 = {
				has_state_flag = EH_state_with_destroyed_portal
				has_state_flag = EH_state_with_portal
			}
		}
		destroy_entity = 9992
		damage_units = {
			region = 191
			limit = { original_tag = ALN }
			damage = 1
		}
		457 = {
			clr_state_flag = EH_state_with_destroyed_portal
			clr_state_flag = EH_state_with_portal
		}
	}
	if = {
		limit = {
			234 = {
				has_state_flag = EH_state_with_destroyed_portal
				has_state_flag = EH_state_with_portal
			}
		}
		destroy_entity = 9993
		damage_units = {
			region = 133
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 183
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 132
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 186
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 185
			limit = { original_tag = ALN }
			damage = 1
		}
		234 = {
			clr_state_flag = EH_state_with_destroyed_portal
			clr_state_flag = EH_state_with_portal
		}
	}
	if = {
		limit = {
			814 = {
				has_state_flag = EH_state_with_destroyed_portal
				has_state_flag = EH_state_with_portal
			}
		}
		destroy_entity = 9994
		damage_units = {
			region = 33
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 182
			limit = { original_tag = ALN }
			damage = 1
		}
		damage_units = {
			region = 122
			limit = { original_tag = ALN }
			damage = 1
		}
		814 = {
			clr_state_flag = EH_state_with_destroyed_portal
			clr_state_flag = EH_state_with_portal
		}
	}
}