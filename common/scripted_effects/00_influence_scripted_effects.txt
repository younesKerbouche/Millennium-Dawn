# Author(s): Angriest Bird, Kal, SWF51, Killerrabit
# Millennium Dawn's Influence System:
# The influence system is MD's take on using political soft power and pressuring other nations.
# It is intended to mock superpower's sphere of influence.

# Effect: init_influence
# Purpose: This is the main effect that is used to initialize the influence array
init_influence = {
	clear_array = influence_array_val
	clear_array = influence_array
}

# Effect: startup_influence
# Purpose: This is the main effect that is used to startup the influence array. Everything else is fired in the on_startup.
startup_influence = {
	sort_influence = yes
}

# Effect: update_dirty_influence_var
# Purpose: This is the main effect that is used to update the dirty influence variable
update_dirty_influence_var = {
	if = {
		limit = {
			NOT = { has_variable = global.update_influence_ui }
			check_variable = { global.update_influence_ui = 10000 }
		}
		set_variable = { global.update_influence_ui = 1 }
	}
	else = {
		add_to_variable = { global.update_influence_ui = 1 }
	}
}

# Effect: recalculate_influence
# Purpose: This is the main effect that is used to recalculate the influence
recalculate_influence = {
	hidden_effect = {
		sort_influence = yes
		calculate_influence_percentage = yes
		delete_influencer_check = yes
		sort_influence = yes

		# Updated Influencer for CT
		set_counter_terror_influencer = yes
		update_dirty_influence_var = yes
	}
}

# Effect: sort_influence
# Purpose: This is the main effect that is used to sort the influence array
sort_influence = {
	# Creation of temp arrays.
	# The arrays are "copied" from influence_array and influence_array_val for sorting
	resize_temp_array = {
		array = influence_array_val_temp
		size = influence_array_val^num
	}
	resize_temp_array = {
		array = influence_array_temp
		size = influence_array_val^num
	}
	# Sort the values by largest influencer
	for_loop_effect = {
		end = influence_array_val^num
		value = v
		find_highest_in_array = {
			array = influence_array_val
			value = max
			index = max_index
		}
		set_temp_variable = { influence_array_val_temp^v = max } #sets biggest at the earliest available position
		set_temp_variable = { influence_array_temp^v = influence_array^max_index } #sets biggest TAG at the earliest available position
		set_variable = { influence_array_val^max_index = -1 } #removes it from selection
	}

	# Clears the Values
	init_influence = yes

	set_temp_variable = { influence_total = 0 }
	# Restores destroyed arrays in the above process - i.e. if they were deleted due to being less then 1%
	for_each_loop = {
		array = influence_array_val_temp
		add_to_array = { influence_array_val = v }
		add_to_temp_variable = { influence_total = v }
	}
	add_to_temp_variable = { influence_total = domestic_influence_amount }
	for_each_loop = {
		array = influence_array_temp
		add_to_array = { influence_array = v }
	}
	clear_temp_array = influence_array_val_temp
	clear_temp_array = influence_array_temp

	set_temp_variable = { new_influence_scalar = 100 }
	divide_temp_variable = { new_influence_scalar = influence_total }
	multiply_variable = { domestic_influence_amount = new_influence_scalar }
	clamp_variable = { var = domestic_influence_amount max = 100 min = 0 }
	for_each_loop = {
		array = influence_array_val
		value = v
		index = i
		multiply_variable = { influence_array_val^i = new_influence_scalar }
		clamp_variable = { var = influence_array_val^i max = 100 min = 0 }
	}

	set_temp_variable = { new_influence_total = 0 }
	add_to_temp_variable = { new_influence_total = domestic_influence_amount }
	for_each_loop = {
		array = influence_array_val
		value = v
		index = i
		add_to_temp_variable = { new_influence_total = v }
	}

	if = { limit = { NOT = { check_variable = { new_influence_total = 100 } } }
		set_temp_variable = { difference = 100 }
		subtract_from_temp_variable = { difference = new_influence_total }
		add_to_variable = { domestic_influence_amount = difference }
		clamp_variable = { var = domestic_influence_amount min = 0 }
	}
}

# Effect: calculate_influence_percentage
# Purpose: This is the main effect that is used to calculate the influence drift percentage
calculate_influence_percentage = {
	set_temp_variable = { influence_democratic = 0 }
	set_temp_variable = { influence_neutrality = 0 }
	set_temp_variable = { influence_communism = 0 }
	set_temp_variable = { influence_nationalist = 0 }
	set_temp_variable = { influence_fascism = 0 }

	for_loop_effect = {
		end = influence_array_val^num
		if = { limit = { var:influence_array^v = { has_government = democratic } }
			add_to_temp_variable = { influence_democratic = influence_array_val^v }
		}
		else_if = { limit = { var:influence_array^v = { has_government = neutrality } }
			add_to_temp_variable = { influence_neutrality = influence_array_val^v }
		}
		else_if = { limit = { var:influence_array^v = { has_government = communism } }
			add_to_temp_variable = { influence_communism = influence_array_val^v }
		}
		else_if = { limit = { var:influence_array^v = { has_government = nationalist } }
			add_to_temp_variable = { influence_nationalist = influence_array_val^v }
		}
		else_if = { limit = { var:influence_array^v = { has_government = fascism } }
			add_to_temp_variable = { influence_fascism = influence_array_val^v }
		}
	}

	if = { limit = { NOT = { has_dynamic_modifier = { modifier = influence_drift_modifier } } }
		add_dynamic_modifier = { modifier = influence_drift_modifier }
	}

	set_variable = { nationalist_drift_influence_var = influence_nationalist }
	set_variable = { fascism_drift_influence_var = influence_fascism }
	set_variable = { neutrality_drift_influence_var = influence_neutrality }
	set_variable = { communism_drift_influence_var = influence_communism }
	set_variable = { democratic_drift_influence_var = influence_democratic }

	multiply_variable = { nationalist_drift_influence_var = 0.001 }
	multiply_variable = { fascism_drift_influence_var = 0.001 }
	multiply_variable = { neutrality_drift_influence_var = 0.001 }
	multiply_variable = { communism_drift_influence_var = 0.001 }
	multiply_variable = { democratic_drift_influence_var = 0.001 }

	force_update_dynamic_modifier = yes
}

# Influence AI Section:
# These are general macro effects used in the influence AI.
# Spread Influence:
# Corresponds with the general spread influence button.
spread_influence = {
	PREV = { add_political_power = -50 }

	set_temp_variable = { percent_change = global.percent_change_value }
	set_temp_variable = { tag_index = PREV.id }
	set_temp_variable = { influence_target = THIS.id }
	change_influence_percentage = yes

	if = { limit = { economic_aid_available = yes }
		economic_aid_action = yes
	}
	if = { limit = { target_other_influence_available = yes }
		target_other_influencer_action = yes
	}
	if = { limit = { manipulate_politics_action_available = yes }
		manipulate_politics_action = yes
	}
	if = { limit = { coup_is_available = yes }
		influence_coup_action = yes
	}
	if = { limit = { make_puppet_action_available = yes }
		make_puppet_action = yes
	}
}

# Effect: make_puppet_action
# Purpose: This is the main effect that is used to puppet another nation
make_puppet_action = {
	#eventually remove explotation idea (shouldn't double up)
	for_loop_effect = {
		end = influence_array^num
		value = v

		meta_effect = {
			text = {
				remove_ideas = tribute_idea_[THISTAG]
			}
			THISTAG = "[?var:influence_array^v.GetTag]"
		}
	}

	PREV = {
		if = {
			limit = {
				has_global_flag = GAME_RULE_allow_colored_puppets
			}
			set_autonomy = {
				target = PREV
				autonomy_state = autonomy_satellite_state_colored
				freedom_level = 0.5
			}
		}
		else = {
			set_autonomy = {
				target = PREV
				autonomy_state = autonomy_satellite_state
				freedom_level = 0.5
			}
		}
		add_named_threat = { threat = 2 name = created_puppet_loc }
	}
	every_neighbor_country = {
		add_opinion_modifier = { target = PREV modifier = puppeted_neighbor }
	}
}

# Effect: economic_exploitation_action
# Purpose: This is the main effect that is used to economically exploit another nation
economic_exploitation_action = {
	meta_effect = {
		text = {
			add_timed_idea = {
				idea = tribute_idea_[ROOTTAG]
				days = 90
			}
		}
		ROOTTAG = "[var:influence_array^0.GetTag]"
	}

	# Remove 10% Influence
	set_temp_variable = { percent_change = -10 }
	set_temp_variable = { tag_index = PREV.id }
	set_temp_variable = { influence_target = THIS.id }
	change_influence_percentage = yes

	#Opinion Modifiers
	add_opinion_modifier = { target = PREV modifier = exploited_us }
	every_neighbor_country = {
		add_opinion_modifier = { target = PREV modifier = exploited_neighbor }
	}
}

# Effect: manipulate_politics_action
# Purpose: This is the main effect that is used to manipulate the politics of another nation
manipulate_politics_action = {
	# Add +5 to Our Outlook
	if = { limit = { PREV = { has_government = fascism } }
		add_popularity = { ideology = fascism popularity = 0.05 }
	}
	else_if = { limit = { PREV = { has_government = neutrality } }
		add_popularity = { ideology = neutrality popularity = 0.05 }
	}
	else_if = { limit = { PREV = { has_government = communism } }
		add_popularity = { ideology = communism popularity = 0.05 }
	}
	else_if = { limit = { PREV = { has_government = nationalist } }
		add_popularity = { ideology = nationalist popularity = 0.05 }
	}
	else_if = { limit = { PREV = { has_government = democratic } }
		add_popularity = { ideology = democratic popularity = 0.05 }
	}

	#add +5 to our party
	for_each_loop = {
		array = PREV.ruling_party
		value = v
		add_to_variable = { party_pop_array^v = 0.05 }
	}

	# Remove 10% Influence
	set_temp_variable = { percent_change = -5 }
	set_temp_variable = { tag_index = PREV.id }
	set_temp_variable = { influence_target = THIS.id }
	change_influence_percentage = yes

	#reduce relations if different gov
	if = { limit = { NOT = { is_same_government_PREV = yes } }
		add_opinion_modifier = { target = PREV modifier = supported_opposition }
	}
}

economic_aid_action = {
	PREV = {
		PREV = {
			country_event = { id = influence.0 }
		}
	}
}

target_other_influencer_action = {
	PREV = {
		PREV = {
			country_event = { id = influence.22 }
		}
	}
}

influence_coup_action = {
	PREV = {
		PREV = {
			country_event = { id = influence.44 }
		}
	}
}

# Effect: delete_influencer_check
# Purpose: This is the main effect that is used to delete an influencer
delete_influencer_check = {
	# Influence Array Indexer
	# Purpose:
	# The loop conditional is configured to remove a influencer if they fall below 0.01% influence
	for_each_loop = {
		array = influence_array_val
		if = { limit = { check_variable = { influence_array_val^i < 0.01 } }
			if = { limit = { check_variable = { influence_array^i > 0 } }
				log = "[GetDateText]: [This.GetName]: Influencer Falling Below 0.01%. Debug Code: 1000. Influencer: [?var:influence_array^i.GetName] Index: [?i]"
				remove_from_array = { array = influence_array index = i }
				remove_from_array = { array = influence_array_val index = i }
			}
		}
	}

	# Delete Double Influencer
	# Purpose:
	# Configured to remove "Double Influencer"
	for_each_loop = {
		array = influence_array
		index = i
		# Ensures the Index is Not Empty
		if = { limit = { NOT = { check_variable = { influence_array^i = 0 } } }
			if = {
				limit = {
					any_of = {
						array = influence_array
						value = v
						index = c
						check_variable = { influence_array^c = influence_array^i }
						NOT = { check_variable = { c = i } }
					}
				}
				log = "[GetDateText]: [This.GetName]: Double Influencer Present. Debug Code: 1001. Influencer: [?var:influence_array^i.GetName] Index: [?i], Duplicate Influencer: [?var:influence_array^i.GetName] Index: [?c]"
				add_to_variable = { influence_array_val^i = influence_array_val^c }
				remove_from_array = { array = influence_array index = c }
				remove_from_array = { array = influence_array_val index = c }
			}
		}
	}


	# Delete Non-Existent Nation
	# Purpose:
	# Configured to remove nations that no longer exist. i.e. They have been annexed. It is a garbage collection event.
	for_loop_effect = {
		end = influence_array^num
		value = v
		set_temp_variable = { temp_tag = 0 }
		add_to_temp_variable = { temp_tag = influence_array^v }
		if = { limit = { NOT = { country_exists = var:temp_tag } }
			remove_from_array = { array = influence_array index = v }
			remove_from_array = { array = influence_array_val index = v }
		}
	}
}

# Effect: change_domestic_influence_percentage
# Purpose: This is the main effect that is used to change the domestic influence percentage
# Parameters:
# - percent_change: The percentage change to the influence
# - influencer_index: The index of the influencer nation, supports all native country scopes
change_domestic_influence_percentage = {
	set_temp_variable = { influence_outlook_amount = 0 }
	for_each_loop = {
		array = influence_array_val
		value = v
		index = i
		add_to_temp_variable = { influence_outlook_amount = v }
	}

	add_to_variable = { domestic_influence_amount = percent_change }
	set_temp_variable = { temp_total = 100 }
	subtract_from_temp_variable = { temp_total = domestic_influence_amount }

	divide_temp_variable = { temp_total = influence_outlook_amount }
	for_each_loop = {
		array = influence_array_val
		value = v
		index = i

		multiply_variable = { influence_array_val^i = temp_total }
	}
	recalculate_influence = yes

	custom_effect_tooltip = change_domestic_influence_percentage_tt
}

# Effect: change_current_influencer_index_percentage
# Purpose: This is the main effect that is used to change influence on another nation
# Parameters:
# - percent_change: The percentage change to the influence
# - influencer_index: The index of the influencer nation, supports all native country scopes
change_current_influencer_index_percentage = {

	set_temp_variable = { percent_change_temp = percent_change }
	set_temp_variable = { influence_outlook_amount = 0 }
	add_to_temp_variable = { influence_outlook_amount = domestic_influence_amount }

	for_each_loop = {
		array = influence_array_val
		value = v
		index = i

		add_to_temp_variable = { influence_outlook_amount = v }
	}
	clamp_variable = { var = influence_outlook_amount max = 100 min = 0 }
	subtract_from_temp_variable = { influence_outlook_amount = influence_array_val^influencer_index }

	add_to_variable = { influence_array_val^influencer_index = percent_change_temp }
	set_temp_variable = { temp_total = 100 }
	subtract_from_temp_variable = { temp_total = influence_array_val^influencer_index }

	divide_temp_variable = { temp_total = influence_outlook_amount }
	multiply_variable = { domestic_influence_amount = temp_total }
	for_each_loop = {
		array = influence_array_val
		value = v
		index = i

		if = { limit = { NOT = { check_variable = { i = 0 } } }
			multiply_variable = { influence_array_val^i = temp_total }
		}
	}
	recalculate_influence = yes
	set_temp_variable = { percent_change = percent_change_temp }

	custom_effect_tooltip = change_index_influencer_tt
}

# Effect: change_influence_percentage
# Purpose: This is the main effect that is used to change influence on another nation
# Parameters:
# - percent_change: The percentage change to the influence
# - tag_index: The tag of the influencer nation, supports all native country scopes
# - influence_target: The tag of the influence target nation, supports all native country scopes
change_influence_percentage = {
	set_temp_variable = { tg = tag_index }
	set_temp_variable = { it = influence_target }
	set_temp_variable = { itd = 0 }

	# Debugging/Logging Handling  in the first section
	if = { limit = { is_debug = yes }
		log = "[GetDateText]: [ROOT.GetName]: DEBUG: Influence Change, Influencer: [?var:tg.GetName.GetName], Influencee: [?var:it.GetName], Influence Domestic Independence: [?itd]"
	}
	if = { limit = { check_variable = { tg = it } }
		custom_effect_tooltip = change_influencer_tt_error

	}

	set_temp_variable = { percent_change_temp = percent_change }
	var:influence_target = {
		# DO NOT ADD YOURSELF TO YOUR OWN INFLUENCE ARRAY
		if = { limit = { check_variable = { tg = it } }
			log = "[GetDateText]: [ROOT.GetName]: ERROR: Influencer and Influencee are the same. Error Code: 5001. Influencer: [?var:tg.GetName], Influencee: [?var:it.GetName]"
		}
		else = {
			set_temp_variable = { itd = THIS.domestic_influence_amount }
			set_temp_variable = { size_of_influence_array = -1 }
			set_temp_variable = { influencer_index = 0 }

			for_each_loop = {
				array = influence_array
				value = v
				index = i
				if = { limit = { check_variable = { v = var:tag_index } }
					set_temp_variable = { influencer_index = i }
				}
				if = { limit = { NOT = { check_variable = { v = 0 } } }
					add_to_temp_variable = { PREV.size_of_influence_array = 1 }
				}
			}
			if = { limit = { check_variable = { influencer_index = 0 } }
				add_to_array = { influence_array = var:tag_index }
				add_to_array = { influence_array_val = 0 }

				set_temp_variable = { influencer_index = size_of_influence_array }
				add_to_temp_variable = { influencer_index = 1 }
			}

			# Apply multiplier in positive interaction
			# You shouldn't lose more because you are a bigger power
			if = { limit = { check_variable = { percent_change > 0 } }

				var:tag_index = {
					set_temp_variable = { influence_change = modifier@foreign_influence_modifier }
					if = { limit = { PREV_is_not_on_same_continent = yes }
						add_to_temp_variable = { influence_change = modifier@foreign_influence_continent_modifier }
					}
					if = { limit = { PREV_is_on_same_continent = yes }
						add_to_temp_variable = { influence_change = modifier@foreign_influence_continent_modifier }
					}
				}

				set_temp_variable = { influence_defense_change = modifier@foreign_influence_defense_modifier }
				subtract_from_temp_variable = { influence_change = influence_defense_change }


				# Custom Influence Amount
				# HOW TO: You will want to check if the tag_index is the original tag
				# the has idea will check if the target country has an idea. It can be used to
				# make a countries influence more effective or worse.
				if = {
					limit = {
						check_variable = { tag_index = ISR }
						has_idea = full_isr_boycotte
					}
					add_to_temp_variable = { influence_change = -0.10 }
				}
				if = {
					limit = {
						check_variable = { tag_index = ISR }
						has_idea = pol_isr_boycotte
					}
					add_to_temp_variable = { influence_change = -0.05 }
				}
				if = {
					limit = {
						check_variable = { tag_index = USA }
						has_idea = USA_usaid
					}
					add_to_temp_variable = { influence_change = 0.05 }
				}
				if = {
					limit = {
						OR = {
							has_idea = cfa_franc
							has_idea = cfa_franc_2
						}
						check_variable = { tag_index = FRA.id }
					}
					add_to_temp_variable = { influence_change = 0.10 }
				}
				if = {
					limit = {
						has_dynamic_modifier = {
							modifier = AFRICA_idea_nepad_modifier
						}
						check_variable = { tag_index = FRA.id }
					}
					add_to_temp_variable = { influence_change = 0.10 }
				}

				if = {
					limit = {
						has_idea = IRQ_expulsion_of_iranian_idea
						check_variable = { tag_index = PER }
					}
					add_to_temp_variable = { influence_change = -0.15 }
				}

				if = {
					limit = {
						has_idea = NKO_china_economic_assistant
						check_variable = { tag_index = CHI }
					}
					add_to_temp_variable = { influence_change = 0.5 }
				}

				if = {
					limit = {
						has_idea = IRQ_expulsion_of_foreigners_idea
						OR = {
							check_variable = { tag_index = PER }
							check_variable = { tag_index = USA }
						}
					}
					add_to_temp_variable = { influence_change = -0.25 }
				}

				if = {
					limit = {
						OR = {
							has_idea = PMR_gazprom_gaz
							has_idea = PMR_ruble_efffect_idea
							has_idea = PMR_russian_legacy
							has_idea = SOV_IRQ_base
							has_idea = SOV_nord_stream_idea
							has_idea = SOV_nord_stream2_idea
							has_idea = SOV_blue_stream_idea
							has_idea = SOV_turkey_stream_idea
							has_idea = PMR_14_army
							has_idea = PMR_sov_idea
							has_idea = USR_parlament_idea
							has_idea = USR_gos_sovet_idea
							has_idea = USR_council_ministers_idea
							has_idea = USR_money_palata_idea
							has_idea = USR_money_palata_idea
							has_idea = USR_eternal_commitie_idea
							has_idea = USR_valute_idea
							has_idea = USR_civils_idea
							has_idea = USR_economic_space_idea
							has_idea = BUL_lukoil_russian_idea
							has_idea = BUL_lukoil_russian_idea1
						}
						check_variable = { tag_index = SOV }
					}
					add_to_temp_variable = { influence_change = 0.15 }
				}
				if = {
					limit = {
						OR = {
							has_idea = SOV_foreign_chinacars_idea
							has_idea = SOV_foreign_chinacars_idea1
							has_idea = SOV_foreign_chinacars_idea2
						}
						check_variable = { tag_index = CHI }
					}
					add_to_temp_variable = { influence_change = 0.03 }
				}

				if = {
					limit = {
						original_tag = ARM
					}
					if = {
						limit = {
							OR = {
								has_idea = ARM_economy_grand_tobacco_idea
								has_idea = ARM_economy_masis_tobacco_idea
							}
							check_variable = { tag_index = CAN }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							OR = {
								has_idea = ARM_economy_hsbc_idea
								has_idea = ARM_education_brit_idea
							}
							check_variable = { tag_index = ENG }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							OR = {
								has_idea = ARM_economy_ycrdi_idea
								has_idea = ARM_Eraz_idea
								has_idea = ARM_education_mgu_idea
							}
							check_variable = { tag_index = SOV }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							has_idea = CHE_republic_rf
							check_variable = { tag_index = SOV }
						}
						add_to_temp_variable = { influence_change = 0.99 }
					}
					if = {
						limit = {
							has_idea = ARM_economy_shoghakn_idea1
							check_variable = { tag_index = ISR }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							has_idea = ARM_economy_veon_idea
							check_variable = { tag_index = HOL }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							has_idea = ARM_armbel_trade_center
							check_variable = { tag_index = BLR }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							OR = {
								has_idea = ARM_it_sector_idea1
								has_idea = ARM_it_sector_idea2
								has_idea = ARM_it_sector_idea3
								has_idea = ARM_it_sector_idea4
								has_idea = ARM_it_sector_idea5
								has_idea = ARM_it_sector_idea6
								has_idea = ARM_it_sector_idea7
								has_idea = ARM_it_sector_idea8
								has_idea = ARM_it_sector_idea9
								has_idea = ARM_education_aua_idea
								has_idea = ARM_usa_embaracy_idea
							}
							check_variable = { tag_index = USA }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							OR = {
								has_idea = ARM_usa_ngo_leave_idea
							}
							check_variable = { tag_index = USA }
						}
						add_to_temp_variable = { influence_change = -0.15 }
					}
					if = {
						limit = {
							OR = {
								has_idea = ARM_zhirayr_no_russian_idea
							}
							check_variable = { tag_index = SOV }
						}
						add_to_temp_variable = { influence_change = -0.15 }
					}
					if = {
						limit = {
							OR = {
								has_idea = ARM_education_erasmus_idea
								has_idea = ARM_armenian_foreign_legion_idea
								has_idea = ARM_education_france_idea
							}
							check_variable = { tag_index = FRA }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							has_idea = ARM_education_erasmus_idea
							check_variable = { tag_index = GER }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}

				}

				if = {
					limit = {
						original_tag = PMR
					}
					if = {
						limit = {
							has_idea = PMR_ger_idea
							check_variable = { tag_index = GER }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}

					if = {
						limit = {
							has_idea = PMR_ita_idea
							check_variable = { tag_index = ITA }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}

					if = {
						limit = {
							has_idea = PMR_rom_idea
							check_variable = { tag_index = ROM }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}

					if = {
						limit = {
							has_idea = PMR_aus_idea
							check_variable = { tag_index = AUS }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							has_idea = PMR_hun_idea
							check_variable = { tag_index = HUN }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}

					if = {
						limit = {
							has_idea = PMR_ukr_idea
							check_variable = { tag_index = UKR }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							has_idea = PMR_chinese_economic
							check_variable = { tag_index = CHI }
						}
						add_to_temp_variable = { influence_change = 0.15 }
					}
					if = {
						limit = {
							has_idea = PMR_inter_rao
							check_variable = { tag_index = SOV }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
					if = {
						limit = {
							OR = {
								has_idea = PMR_reform_debuff1
								has_idea = PMR_annex_efffect_idea1
								has_idea = PMR_army_efffect_idea1
							}
							check_variable = { tag_index = MLV }
						}
						add_to_temp_variable = { influence_change = 0.15 }
					}
					if = {
						limit = {
							OR = {
								has_idea = PMR_ukr_army
								has_idea = PMR_grivna_efffect_idea
							}
							check_variable = { tag_index = UKR }
						}
						add_to_temp_variable = { influence_change = 0.15 }
					}
				}

				if = {
					limit = {
						original_tag = BLR
					}
					if = {
						limit = {
							has_idea = ARM_zhirayr_in_blr_ukr_idea
							check_variable = { tag_index = ARM }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
				}

				if = {
					limit = {
						original_tag = UKR
					}
					if = {
						limit = {
							has_idea = ARM_zhirayr_in_blr_ukr_idea
							check_variable = { tag_index = ARM }
						}
						add_to_temp_variable = { influence_change = 0.10 }
					}
				}


				if = {
					limit = {
						original_tag = TAJ
					}
					if = {
						limit = {
							has_idea = TAJ_tajik_barrier2
							check_variable = { tag_index = SOV }
						}
						add_to_temp_variable = { influence_change = -0.25 }
					}

					if = {
						limit = {
							OR = {
								has_idea = TAJ_201st_base
								has_idea = TAJ_201st_base_upgrade
							}
							check_variable = { tag_index = SOV }
						}
						add_to_temp_variable = { influence_change = 0.30 }
					}

					if = {
						limit = {
							has_idea = TAJ_201st_base_usa
							check_variable = { tag_index = USA }
						}
						add_to_temp_variable = { influence_change = 0.15 }
					}
					if = {
						limit = {
							has_idea = TAJ_201st_base_raj
							check_variable = { tag_index = RAJ }
						}
						add_to_temp_variable = { influence_change = 0.15 }
					}
					if = {
						limit = {
							has_idea = TAJ_201st_base_chi
							check_variable = { tag_index = CHI }
						}
						add_to_temp_variable = { influence_change = 0.15 }
					}

					if = {
						limit = {
							has_idea = TAJ_gulfs_bankroll_idea
							check_variable = { tag_index = SAU }
						}
						add_to_temp_variable = { influence_change = 0.15 }
					}
				}

				if = {
					limit = {
						original_tag = PER
					}
					if = {
						limit = {
							has_idea = PER_fighting_colonialism
							check_variable = { tag_index = SOV }
						}
						add_to_temp_variable = { influence_change = -0.25 }
					}
					if = {
						limit = {
							has_idea = PER_fighting_colonialism
							check_variable = { tag_index = USA }
						}
						add_to_temp_variable = { influence_change = -0.25 }
					}
					if = {
						limit = {
							has_idea = PER_fighting_colonialism
							check_variable = { tag_index = ENG }
						}
						add_to_temp_variable = { influence_change = -0.25 }
					}

				}

				if = {
					limit = {
						has_idea = PER_strength_of_our_lobby
						OR = {
							check_variable = { tag_index = ISR }
							check_variable = { tag_index = USA }
						}
					}
					add_to_temp_variable = { influence_change = -0.25 }
				}

				add_to_temp_variable = { influence_change = 1 }
				multiply_temp_variable = { percent_change = influence_change }
			}

			if = {
				limit = {
					check_variable = { influence_array_val^6 > 0 }
					all_of_scopes = {
						array = influence_array
						NOT = { original_tag = var:tag_index }
					}
				}

				if = { limit = { check_variable = { percent_change > influence_array_val^6 } }
					set_variable = { influence_array^6 = var:tag_index }
					set_variable = { influence_array_val^6 = percent_change }
					set_temp_variable = { influencer_index = 6 }

					set_temp_variable = { influence_outlook_amount = 0 }
					add_to_temp_variable = { influence_outlook_amount = domestic_influence_amount }

					for_each_loop = {
						array = influence_array_val
						value = v
						index = i

						add_to_temp_variable = { influence_outlook_amount = v }
					}
					subtract_from_temp_variable = { influence_outlook_amount = influence_array_val^influencer_index }

					add_to_variable = { influence_array_val^influencer_index = percent_change }
					set_temp_variable = { temp_total = 100 }
					subtract_from_temp_variable = { temp_total = influence_array_val^influencer_index }

					divide_temp_variable = { temp_total = influence_outlook_amount }
					multiply_variable = { domestic_influence_amount = temp_total }
					for_each_loop = {
						array = influence_array_val
						value = v
						index = i

						if = { limit = { NOT = { check_variable = { i = 0 } } }
							multiply_variable = { influence_array_val^i = temp_total }
						}
					}
					recalculate_influence = yes

					custom_effect_tooltip = change_influencer_tt
				}
				else = {
					# Creates the summation of all array calculations
					set_temp_variable = { influence_outlook_amount = 0 }
					for_each_loop = {
						array = influence_array_val
						value = v
						index = i
						add_to_temp_variable = { influence_outlook_amount = v }
					}

					add_to_variable = { domestic_influence_amount = percent_change }
					set_temp_variable = { temp_total = 100 }
					subtract_from_temp_variable = { temp_total = domestic_influence_amount }

					divide_temp_variable = { temp_total = influence_outlook_amount }
					for_each_loop = {
						array = influence_array_val
						value = v
						index = i

						multiply_variable = { influence_array_val^i = temp_total }
					}
					recalculate_influence = yes

					custom_effect_tooltip = change_domestic_influence_percentage_tt
				}
			}
			else = {
				set_temp_variable = { influence_outlook_amount = 0 }
				add_to_temp_variable = { influence_outlook_amount = domestic_influence_amount }

				for_each_loop = {
					array = influence_array_val
					value = v
					index = i

					add_to_temp_variable = { influence_outlook_amount = v }
				}
				subtract_from_temp_variable = { influence_outlook_amount = influence_array_val^influencer_index }

				add_to_variable = { influence_array_val^influencer_index = percent_change }
				set_temp_variable = { temp_total = 100 }
				subtract_from_temp_variable = { temp_total = influence_array_val^influencer_index }

				divide_temp_variable = { temp_total = influence_outlook_amount }
				multiply_variable = { domestic_influence_amount = temp_total }
				for_each_loop = {
					array = influence_array_val
					value = v
					index = i

					if = { limit = { NOT = { check_variable = { i = 0 } } }
						multiply_variable = { influence_array_val^i = temp_total }
					}
				}
				recalculate_influence = yes
				custom_effect_tooltip = change_influencer_tt
			}
		}
	}
	set_temp_variable = { percent_change = percent_change_temp }
}

# Effect: init_auto_influence_array
# Purpose: This is the main effect that is used to initialize the auto-influence array
init_auto_influence_array = {
	set_variable = { auto_influence_cap = 3 }
	set_variable = { auto_influence_users = 0 }

	add_to_variable = { auto_influence_cap = modifier@foreign_influence_auto_influence_cap_modifier }
	resize_array = { array = auto_influence_array value = 0 size = 10 } # ONLY 4 MORE SLOTS ARE AVAILABLE
}

# Effect: update_auto_influence_array
# Purpose: This is the main effect that is used to update the auto-influence array
update_auto_influence_array = {
	if = { limit = { is_debug = yes }
		log = "[GetDateText]: [THIS.GetName]: update_auto_influence_array running"
	}
	set_variable = { auto_influence_cap = 3 }
	add_to_variable = { auto_influence_cap = THIS.modifier@foreign_influence_auto_influence_cap_modifier }

	if = { limit = { is_debug = yes }
		log = "[GetDateText]: [THIS.GetName]: auto_influence_cap [?auto_influence_cap]"
	}
	set_variable = { auto_influence_cost = 0 }
	if = { limit = { NOT = { has_dynamic_modifier = { modifier = auto_influencer_cost_effect } } }
		add_dynamic_modifier = { modifier = auto_influencer_cost_effect }
	}

	for_each_loop = {
		array = auto_influence_array
		if = { limit = { check_variable = { i > auto_influence_cap } NOT = { check_variable = { v = 0 } } }
			if = { limit = { is_debug = yes }
				log = "[GetDateText]: [THIS.GetName]: Index [?i] is greater than the auto_influence_cap. Removing [?auto_influence_array^i.GetName] from auto influence list"
			}
			set_variable = { auto_influence_array^i = 0 }
			var:auto_influence_array^i = {
				PREV = {
					remove_auto_influencer_request = yes
				}
			}
		}
		if = {
			limit = { NOT = { check_variable = { v = 0 } } }
			add_to_variable = { auto_influence_cost = 1.50 }
		}
	}

	clamp_variable = { var = ROOT.auto_influence_users min = 0 max = 10 }
	update_dirty_influence_var = yes
}

# Effect: create_new_auto_influencer_request
# Purpose: This is the main effect that is used to create a new auto-influencer request
create_new_auto_influencer_request = {
	if = { limit = { is_debug = yes }
		log = "[GetDateText]: [Root.GetName]: Creation of Auto-Influencer Request. Influencing Nation: [PREV.GetName]"
	}
	for_each_loop = {
		array = auto_influence_array
		if = {
			limit = { check_variable = { v = 0 } }

			set_variable = { new_auto_influencer = i }
			set_temp_variable = { break = 1 }
		}
	}

	if = { limit = { has_variable = new_auto_influencer }
		set_variable = { auto_influence_array^new_auto_influencer = PREV.id }
		add_to_variable = { auto_influence_users = 1 }
		clamp_variable = { var = auto_influence_users min = 0 max = 10 }
		clear_variable = new_auto_influencer
	}
	custom_effect_tooltip = influence_create_new_auto_request_TT
}

# Effect: remove_auto_influencer_request
# Purpose: This is the main effect that is used to remove an auto-influencer request
remove_auto_influencer_request = {
	log = "[GetDateText]: [Root.GetName]: Removal of Auto-Influencer Request. Influencing Nation: [PREV.GetName]"
	set_temp_variable = { index = 0 }
	for_each_loop = {
		array = auto_influence_array
		if = { limit = { check_variable = { v = PREV.id } }
			set_temp_variable = { index = i }
		}
	}

	set_variable = { auto_influence_array^index = 0 }
	subtract_from_variable = { auto_influence_users = 1 }
	clamp_variable = { var = auto_influence_users min = 0 max = 10 }
	custom_effect_tooltip = influence_remove_auto_request_TT
}
