#Written by Doolittle & Marvin
#IF YOU ARE NOT BIRD AND YOU TOUCH THIS
#I WILL KILL YOU. DO. NOT. FUCK. WITH. THE. MATH.
resource_storage_system = {
	resource_storage_steel_calc_effect = yes
	resource_storage_rubber_calc_effect = yes
	resource_storage_light_calc_effect = yes
	resource_storage_tech_calc_effect = yes
	resource_storage_precious_calc_effect = yes

	set_temp_variable = { storage_clamp = modifier@resource_storage_gain }

	clamp_variable = { var = rubber_in_storage min = 0 max = storage_clamp }
	clamp_variable = { var = light_in_storage min = 0 max = storage_clamp }
	clamp_variable = { var = precious_in_storage min = 0 max = storage_clamp }
	clamp_variable = { var = tech_in_storage min = 0 max = storage_clamp }
	clamp_variable = { var = steel_in_storage min = 0 max = storage_clamp }
	update_dirty_resource_storage_var = yes
}

resource_storage_system_setup = {
	set_variable = { rubber_in_storage = 0 }
	set_variable = { light_in_storage = 0 }
	set_variable = { precious_in_storage = 0 }
	set_variable = { tech_in_storage = 0 }
	set_variable = { steel_in_storage = 0 }
	add_dynamic_modifier = { modifier = resource_storage_modifier }
}

resource_storage_steel_calc_effect = {
	#This should include all the steel that the nation has left, *including* the buff
	set_temp_variable = { resource_base_value = resource@steel }
	set_temp_variable = { resource_base_consumed_value = resource_consumed@steel }
	set_temp_variable = { old_resource_draw_value = steel_from_storage }
	subtract_from_temp_variable = { resource_base_value = old_resource_draw_value }

	if = {
		#Only draw resources if we have a deficit, want to draw, and have the resources to draw
		limit = {
			check_variable = { resource_base_value < 1 }
			check_variable = { steel_in_storage > 0 }
			OR = {
				is_ai = yes
				has_country_flag = steel_storage_draw
			}
		}
		#How much total we need is the consumed amount + deficit
		set_temp_variable = { ideal_resource_number = resource_base_consumed_value }
		subtract_from_temp_variable = { ideal_resource_number = resource_base_value }

		multiply_temp_variable = { resource_base_value = -1 }
		subtract_from_variable = { steel_in_storage = resource_base_value }

		if = { limit = { check_variable = { steel_in_storage < 0 } }
			#We overdrew and don't have enough in storage anymore, so reduce the amount taken
			add_to_temp_variable = { resource_base_value = steel_in_storage }
		}
		set_variable = { steel_from_storage = resource_base_value }
		set_variable = { steel_storage_display = resource_base_value }
		set_temp_variable = { resource_base_value = 0 }
	} else = {
		if = {
			#check if we ran out. if we ran out, stop pulling
			limit = { check_variable = { steel_in_storage = 0 } }
			set_variable = { steel_from_storage = 0 }
			set_variable = { steel_storage_display = 0 }
		}
	}
	if = {
		limit = { check_variable = { resource_base_value > 0 } }
		add_to_variable = { steel_in_storage = resource_base_value }
		set_variable = { steel_from_storage = 0 }
		set_variable = { steel_storage_display = resource_base_value }
	}
}

resource_storage_light_calc_effect = {
	#This should include all the steel that the nation has left, *including* the buff
	set_temp_variable = { resource_base_value = resource@aluminium }
	set_temp_variable = { resource_base_consumed_value = resource_consumed@aluminium }
	set_temp_variable = { old_resource_draw_value = light_from_storage }
	subtract_from_temp_variable = { resource_base_value = old_resource_draw_value }

	if = {
		#Only draw resources if we have a deficit, want to draw, and have the resources to draw
		limit = {
			check_variable = { resource_base_value < 1 }
			check_variable = { light_in_storage > 0 }
			OR = {
				is_ai = yes
				has_country_flag = light_storage_draw
			}
		}
		#How much total we need is the consumed amount + deficit
		set_temp_variable = { ideal_resource_number = resource_base_consumed_value }
		subtract_from_temp_variable = { ideal_resource_number = resource_base_value }

		multiply_temp_variable = { resource_base_value = -1 }
		subtract_from_variable = { light_in_storage = resource_base_value }

		if = { limit = { check_variable = { light_in_storage < 0 } }
			#We overdrew and don't have enough in storage anymore, so reduce the amount taken
			add_to_temp_variable = { resource_base_value = light_in_storage }
		}
		set_variable = { light_from_storage = resource_base_value }
		set_variable = { light_storage_display = resource_base_value }
		set_temp_variable = { resource_base_value = 0 }
	} else = {
		if = {
			#check if we ran out. if we ran out, stop pulling
			limit = { check_variable = { light_in_storage = 0 } }
			set_variable = { light_from_storage = 0 }
			set_variable = { light_storage_display = 0 }
		}
	}
	if = {
		limit = { check_variable = { resource_base_value > 0 } }
		add_to_variable = { light_in_storage = resource_base_value }
		set_variable = { light_from_storage = 0 }
		set_variable = { light_storage_display = resource_base_value }
	}
}

resource_storage_rubber_calc_effect = {
	#This should include all the steel that the nation has left, *including* the buff
	set_temp_variable = { resource_base_value = resource@rubber }
	set_temp_variable = { resource_base_consumed_value = resource_consumed@rubber }
	set_temp_variable = { old_resource_draw_value = rubber_from_storage }
	subtract_from_temp_variable = { resource_base_value = old_resource_draw_value }

	if = {
		#Only draw resources if we have a deficit, want to draw, and have the resources to draw
		limit = {
			check_variable = { resource_base_value < 1 }
			check_variable = { rubber_in_storage > 0 }
			OR = {
				is_ai = yes
				has_country_flag = rubber_storage_draw
			}
		}
		#How much total we need is the consumed amount + deficit
		set_temp_variable = { ideal_resource_number = resource_base_consumed_value }
		subtract_from_temp_variable = { ideal_resource_number = resource_base_value }

		multiply_temp_variable = { resource_base_value = -1 }
		subtract_from_variable = { rubber_in_storage = resource_base_value }

		if = { limit = { check_variable = { rubber_in_storage < 0 } }
			#We overdrew and don't have enough in storage anymore, so reduce the amount taken
			add_to_temp_variable = { resource_base_value = rubber_in_storage }
		}
		set_variable = { rubber_from_storage = resource_base_value }
		set_variable = { rubber_storage_display = resource_base_value }
		set_temp_variable = { resource_base_value = 0 }
	} else = {
		if = {
			#check if we ran out. if we ran out, stop pulling
			limit = { check_variable = { rubber_in_storage = 0 } }
			set_variable = { rubber_from_storage = 0 }
			set_variable = { rubber_storage_display = 0 }
		}
	}
	if = {
		limit = { check_variable = { resource_base_value > 0 } }
		add_to_variable = { rubber_in_storage = resource_base_value }
		set_variable = { rubber_from_storage = 0 }
		set_variable = { rubber_storage_display = resource_base_value }
	}
}

resource_storage_tech_calc_effect = {
	set_temp_variable = { resource_base_value = resource@tungsten }
	set_temp_variable = { resource_base_consumed_value = resource_consumed@tungsten }
	set_temp_variable = { old_resource_draw_value = tech_from_storage }
	subtract_from_temp_variable = { resource_base_value = old_resource_draw_value }

	if = {
		#Only draw resources if we have a deficit, want to draw, and have the resources to draw
		limit = {
			check_variable = { resource_base_value < 1 }
			check_variable = { tech_in_storage > 0 }
			OR = {
				is_ai = yes
				has_country_flag = tech_storage_draw
			}
		}
		#How much total we need is the consumed amount + deficit
		set_temp_variable = { ideal_resource_number = resource_base_consumed_value }
		subtract_from_temp_variable = { ideal_resource_number = resource_base_value }

		multiply_temp_variable = { resource_base_value = -1 }
		subtract_from_variable = { tech_in_storage = resource_base_value }

		if = { limit = { check_variable = { tech_in_storage < 0 } }
			#We overdrew and don't have enough in storage anymore, so reduce the amount taken
			add_to_temp_variable = { resource_base_value = tech_in_storage }
		}
		set_variable = { tech_from_storage = resource_base_value }
		set_variable = { tech_storage_display = resource_base_value }
		set_temp_variable = { resource_base_value = 0 }
	} else = {
		if = {
			#check if we ran out. if we ran out, stop pulling
			limit = { check_variable = { tech_in_storage = 0 } }
			set_variable = { tech_from_storage = 0 }
			set_variable = { tech_storage_display = 0 }
		}
	}
	if = {
		limit = { check_variable = { resource_base_value > 0 } }
		add_to_variable = { tech_in_storage = resource_base_value }
		set_variable = { tech_from_storage = 0 }
		set_variable = { tech_storage_display = resource_base_value }
	}
}

resource_storage_precious_calc_effect = {
	set_temp_variable = { resource_base_value = resource@chromium }
	set_temp_variable = { resource_base_consumed_value = resource_consumed@chromium }
	set_temp_variable = { old_resource_draw_value = precious_from_storage }
	subtract_from_temp_variable = { resource_base_value = old_resource_draw_value }

	if = {
		#Only draw resources if we have a deficit, want to draw, and have the resources to draw
		limit = {
			check_variable = { resource_base_value < 1 }
			check_variable = { precious_in_storage > 0 }
			OR = {
				is_ai = yes
				has_country_flag = precious_storage_draw
			}
		}

		#How much total we need is the consumed amount + deficit
		set_temp_variable = { ideal_resource_number = resource_base_consumed_value }
		subtract_from_temp_variable = { ideal_resource_number = resource_base_value }

		multiply_temp_variable = { resource_base_value = -1 }
		subtract_from_variable = { precious_in_storage = resource_base_value }

		if = { limit = { check_variable = { precious_in_storage < 0 } }
			#We overdrew and don't have enough in storage anymore, so reduce the amount taken
			add_to_temp_variable = { resource_base_value = precious_in_storage }
		}
		set_variable = { precious_from_storage = resource_base_value }
		set_variable = { precious_storage_display = resource_base_value }
		set_temp_variable = { resource_base_value = 0 }
	} else = {
		if = {
			#check if we ran out. if we ran out, stop pulling
			limit = { check_variable = { precious_in_storage = 0 } }
			set_variable = { precious_from_storage = 0 }
			set_variable = { precious_storage_display = 0 }
		}
	}
	if = {
		limit = { check_variable = { resource_base_value > 0 } }
		add_to_variable = { precious_in_storage = resource_base_value }
		set_variable = { precious_from_storage = 0 }
		set_variable = { precious_storage_display = resource_base_value }
	}
}

update_dirty_resource_storage_var = {
	if = {
		limit = { check_variable = { global.storage_scripted_gui_var < 1000000 } }
		add_to_variable = { global.storage_scripted_gui_var = 1 }
	}
	else = {
		set_variable = { storage_scripted_gui_var = 0 }
	}
}
