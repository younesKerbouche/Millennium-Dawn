# Scripted effects for NATO
NATO_join = {
	for_each_scope_loop = {
		array = global.nato_members

		# Mutual opinion boost.
		add_opinion_modifier = { target = PREV modifier = NATO_member_modifier }
		reverse_add_opinion_modifier = { target = PREV modifier = NATO_member_modifier }

		# Add military access.
		if = { limit = { NOT = { has_military_access_to = PREV } }
			diplomatic_relation = {
				country = PREV
				relation = military_access
				active = yes
			}
			PREV = {
				diplomatic_relation = {
					country = PREV
					relation = military_access
					active = yes
				}
			}
		}
	}

	add_to_array = { global.nato_members = THIS }
	add_ideas = NATO_member
	add_to_tech_sharing_group = NATO_Tech_Share
	random_country = {
		limit = {
			has_idea = NATO_member
			is_faction_leader = yes
		}
		add_to_faction = ROOT
	}

	if = {
		limit = { has_idea = Major_Non_NATO_Ally }
		remove_ideas = Major_Non_NATO_Ally
	}

	custom_effect_tooltip = NATO_join_tt

	hidden_effect = { news_event = { id = NATO.8 hours = 6 } }
}

#USE INSTEAD OF USA = { country_event = NATO.14 } TO BE SURE USA WONT APPLY MEMBERSHIP IF THEY ARE NOT NATO MEMBER MORE
NATO_join_via_event = {
	if = {
		limit = {
			USA = {
				has_idea = NATO_member
				is_faction_leader = yes
			}
		}
		USA = { country_event = NATO.14 }
	}
	else = {
		random_country = {
			limit = {
				has_idea = NATO_member
				is_faction_leader = yes
			}
			country_event = NATO.14
		}
	}
}

NATO_leave = {
	if = {
		limit = { has_idea = NATO_member }

		remove_from_array = { global.nato_members = THIS }
		remove_ideas = NATO_member
		remove_from_tech_sharing_group = NATO_Tech_Share
		leave_faction = yes

		for_each_scope_loop = {
			array = global.nato_members
			if = {
				limit = { has_idea = NATO_member }
				# Nato members are mad you left.
				add_opinion_modifier = { target = PREV modifier = left_nato }

				# Remove nato opinion boost.
				remove_opinion_modifier = { target = PREV modifier = NATO_aspirant }
				remove_opinion_modifier = { target = PREV modifier = NATO_member_modifier }
				PREV = {
					remove_opinion_modifier = { target = PREV modifier = NATO_member_modifier }
					remove_opinion_modifier = { target = PREV modifier = NATO_aspirant }
				}

				# Remove military access.
				diplomatic_relation = {
					country = PREV
					relation = military_access
					active = no
				}
				PREV = {
					diplomatic_relation = {
						country = PREV
						relation = military_access
						active = no
					}
				}
			}
		}

		custom_effect_tooltip = NATO_leave_tt

		hidden_effect = { news_event = { id = NATO.6 hours = 6 } }
	}
}

NATO_show_non_ratified_countries = {
	every_country = {
		limit = {
			has_idea = NATO_member
			NOT = { has_country_flag = NATO_Ratified_@ROOT }
		}
		display_individual_scopes = yes

		set_temp_variable = { selected_tag = THIS.id }
		TAG_get_name_with_flag = yes
		newline = yes
	}
}

NATO_CSTO_calculate_number_of_batallions = {
	set_variable = { global.var_nato_inf_count = 0 }
	set_variable = { global.var_csto_inf_count = 0 }
	set_variable = { global.var_nato_tank_count = 0 }
	set_variable = { global.var_csto_tank_count = 0 }

	every_country = {
		limit = {
			has_idea = NATO_member
			is_european_nation = yes
		}

		set_temp_variable = { inf_bat = 0 }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Mech_Air_Inf_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Mech_Marine_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Arm_Air_Inf_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Arm_Marine_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Mech_Inf_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Arm_Inf_Bat }

		set_temp_variable = { tank_bat = 0 }
		add_to_temp_variable = { tank_bat = num_battalions_with_type@armor_Bat }
		add_to_temp_variable = { tank_bat = num_battalions_with_type@L_arm_Bat }

		add_to_variable = { global.var_nato_inf_count = inf_bat }
		add_to_variable = { global.var_nato_tank_count = tank_bat }
	}

	if = {
		limit = {
			OR = {
				check_variable = { global.var_nato_inf_count > 1000 }
				check_variable = { global.var_nato_tank_count > 400 }
			}
		}

		every_country = {
			limit = {
				has_idea = NATO_member
				is_european_nation = yes
			}

			set_country_flag = NATO_CSTO_agreement_breach_warning
			random_country = {
				limit = {
					has_idea = NATO_member
					is_faction_leader = yes
				}

				activate_mission = NATO_CSTO_breach_mission
			}
		}
	}

	every_country = {
		limit = {
			has_idea = CSTO_member
		}

		set_temp_variable = { inf_bat = 0 }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Mech_Air_Inf_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Mech_Marine_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Arm_Air_Inf_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Arm_Marine_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Mech_Inf_Bat }
		add_to_temp_variable = { inf_bat = num_battalions_with_type@Arm_Inf_Bat }

		set_temp_variable = { tank_bat = 0 }
		add_to_temp_variable = { tank_bat = num_battalions_with_type@armor_Bat }
		add_to_temp_variable = { tank_bat = num_battalions_with_type@L_arm_Bat }

		add_to_variable = { global.var_csto_inf_count = inf_bat }
		add_to_variable = { global.var_csto_tank_count = tank_bat }
	}

	if = {
		limit = {
			OR = {
				check_variable = { global.var_csto_inf_count > 1000 }
				check_variable = { global.var_csto_tank_count > 400 }
			}
		}

		every_country = {
			limit = {
				has_idea = CSTO_member
				is_european_nation = yes
			}

			set_country_flag = NATO_CSTO_agreement_breach_warning
			random_country = {
				limit = {
					has_idea = CSTO
					is_faction_leader = yes
				}

				activate_mission = NATO_CSTO_breach_mission
			}
		}
	}
}
