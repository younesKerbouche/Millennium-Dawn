counter_terror_nation_startup = {
	#tracks all starting values for internal threats and international threat detection
	set_variable = { internal_terror_threat = 0 }
	#This mod is add to count for both adding / subtracting terror levels
	set_variable = { internal_terror_threat_mod = 0 }
	set_variable = { internal_radicalization = 0 }
	#This is multiply to represent slow increases, so percent based
	set_variable = { internal_rad_mod = 0 }
	set_variable = { internal_threat_detection = 0 }
	set_variable = { internal_threat_detection_mod = 0 }
	set_variable = { global_terror_threat_detection = 0 }
}

counter_terror_global_setup = {
	setup_orgs = yes
	set_starting_org_locations = yes
	set_starting_org_values = yes
}

setup_all_orgs = {
	#These orgs will be live on game start
	#If this array is ever empty, then you "win" the global war on terror
	add_to_array = { global.active_terror_orgs = 0 } #Al-Queda
	add_to_array = { global.active_terror_orgs = 1 } #Boko Haram
	add_to_array = { global.active_terror_orgs = 2 } #Hizb ut-Tahrir

	#This array tracks inactive global orgs
	#These can come into existance via global events, national collapse, or failure to manage domestic organizations
	#Names will be assigned at random, or to specific orgs
	#Tracked by their value or array position
	add_to_array = { global.inactive_terror_orgs = 3 }
	add_to_array = { global.inactive_terror_orgs = 4 }
	add_to_array = { global.inactive_terror_orgs = 5 }
	add_to_array = { global.inactive_terror_orgs = 6 }
	add_to_array = { global.inactive_terror_orgs = 7 }
	add_to_array = { global.inactive_terror_orgs = 8 }
	add_to_array = { global.inactive_terror_orgs = 9 }
	add_to_array = { global.inactive_terror_orgs = 10 }
}

set_starting_org_locations = {
	#NOTE: DO NOT ADJUST THIS START ORDER
	#If you add starting terror orgs, you need to ENSURE all the arrays line up right
	#Otherwise, all the system will break
	#Damnit pdx, just give me arrays in arrays to make this easy *please*
	add_to_temp_array = { alq_start = 415 }
	add_to_temp_array = { alq_start = 1208 }
	add_to_temp_array = { alq_start = 1207 }
	add_to_temp_array = { alq_start = 411 }
	add_to_temp_array = { alq_start = 1153 }
	add_to_temp_array = { alq_start = 1154 }
	add_to_temp_array = { alq_start = 418 }

	set_temp_variable_to_random = {
		var = start_spot
		min = 0
		max = 6
		integer = yes
	}

	var:alq_start^start_spot = {
		set_state_flag = alq_regional_base
	}

	add_to_array = { global.active_terror_hq = alq_start^start_spot }

	add_to_temp_array = { boko_start = 339 }
	add_to_temp_array = { boko_start = 340 }

	set_temp_variable_to_random = {
		var = start_spot
		min = 0
		max = 1
		integer = yes
	}

	var:boko_start^start_spot = {
		set_state_flag = boko_regional_base
	}

	add_to_temp_array = { hut_start = 202 }
	add_to_temp_array = { hut_start = 168 }
	add_to_temp_array = { hut_start = 553 }

	set_temp_variable_to_random = {
		var = start_spot
		min = 0
		max = 2
		integer = yes
	}

	var:hut_start^start_spot = {
		set_state_flag = hut_regional_base
	}
}

counter_terror_core = {
	#Start by adjusting social conservatism
	if = {
		limit = {
			has_variable = social_conservatism_government
			OR = {
				check_variable = { global.month = 4 }
				check_variable = { global.month = 8 }
				check_variable = { global.month = 12 }
			}
		}
		social_conservatism_adjust = yes
	}
	#Next, for each nation, calculate their potential radicalization
	#This builds off social conservatism;
	calculate_radicalization = yes
	internal_threat_level = yes
	global_war_on_terror = yes
}

global_war_on_terror = {
	#Increase radicalization and threat level for nations that have a regional organization operating in their borders
	set_temp_variable = { global_rad_add = internal_radicalization }
	multiply_temp_variable = { global_rad_add = 0.05 }
	add_to_variable = { global.radicalization = global_rad_add }
}

internal_threat_level = {
	set_temp_variable = { terror_level_base = modifier@internal_threat_increase_modifier }

	set_temp_variable = { level_add_rad = 0 }
	if = {
		limit = {
			check_variable = { internal_radicalization > 15 }
			add_to_temp_variable = { level_add_rad = internal_radicalization }
			multiply_temp_variable = { level_add_rad = 0.06667 }
		}
	}

	add_to_temp_variable = { level_add_rad = internal_terror_threat_mod }

	add_to_temp_variable = { level_add_rad = terror_level_base }
	set_variable = { internal_terror_threat = level_add_rad }

	clamp_threat = yes
}

modify_radicalization_effect = {
	add_to_variable = { internal_radicalization = rad_change }
	custom_effect_tooltip = modify_radicalization_effect_tt
	clamp_radicalization = yes
}

modify_terror_threat_effect = {
	add_to_variable = { internal_terror_threat = threat_change }
	custom_effect_tooltip = modify_terror_threat_effect_tt
	clamp_threat = yes
}

clamp_threat = {
	# Calculate Min/Max Terror Threat
	set_temp_variable = { min_threat = 0 }
	set_temp_variable = { max_threat = 100 }

	add_to_temp_variable = { min_threat = modifier@minimum_terror_threat_modifier }
	add_to_temp_variable = { max_threat = modifier@maximum_terror_threat_modifier }

	if = {
		limit = {
			OR = {
				jihadist_government = yes
				has_completed_focus = GCC_a_radical_reorientation
			}
		}
		add_to_temp_variable = { min_threat = 25 }
	}
	if = {
		limit = { has_war = yes }
		add_to_temp_variable = { min_threat = 10 }
	}
	if = {
		limit = { check_variable = { gdp_per_capita < 10.000 } }
		add_to_temp_variable = { min_threat = 10 }
	}

	clamp_temp_variable = { var = min_threat min = 0 max = 100 }
	clamp_temp_variable = { var = max_threat min = 0 max = 100 }

	clamp_variable = { var = internal_terror_threat min = min_threat max = max_threat }

	set_variable = { min_terror_threat_display = min_threat }
	set_variable = { max_terror_threat_display = max_threat }

	# Set terror threat level
	clr_country_flag = threat_level_critical
	clr_country_flag = threat_level_severe
	clr_country_flag = threat_level_substantial
	clr_country_flag = threat_level_moderate
	clr_country_flag = threat_level_low
	clr_country_flag = threat_level_negligible

	if = { limit = { check_variable = { internal_terror_threat > 80 } }
		set_country_flag = threat_level_critical
	}
	else_if = {
		limit = {
			check_variable = { internal_terror_threat < 81 }
			check_variable = { internal_terror_threat > 50 }
		}
		set_country_flag = threat_level_severe
	}
	else_if = {
		limit = {
			check_variable = { internal_terror_threat < 51 }
			check_variable = { internal_terror_threat > 30 }
		}
		set_country_flag = threat_level_substantial
	}
	else_if = {
		limit = {
			check_variable = { internal_terror_threat < 31 }
			check_variable = { internal_terror_threat > 20 }
		}
		set_country_flag = threat_level_moderate
	}
	else_if = {
		limit = {
			check_variable = { internal_terror_threat < 21 }
			check_variable = { internal_terror_threat > 10 }
		}
		set_country_flag = threat_level_low
	}
	else = {
		set_country_flag = threat_level_negligible
	}

	clamp_variable = { var = internal_terror_threat min = 0 max = 100 }
	missile_ui_update = yes
}

clamp_radicalization = {

	set_temp_variable = { min_radical = 0 }
	set_temp_variable = { max_radical = 100 }

	add_to_temp_variable = { min_radical = modifier@minimum_radicalization_modifier }
	add_to_temp_variable = { max_radical = modifier@maximum_radicalization_modifier }

	if = {
		limit = { check_variable = { gdp_per_capita < 10.000 } }
		add_to_temp_variable = { max_radical = 10 }
	}

	clamp_temp_variable = { var = min_radical min = 0 max = 100 }
	clamp_temp_variable = { var = max_radical min = 0 max = 100 }

	clamp_variable = { var = internal_radicalization min = min_radical max = max_radical }

	set_variable = { min_radical_display = min_radical }
	set_variable = { max_radical_display = max_radical }

	if = {
		limit = {
			NOT = {
				has_idea = youth_radicalization
				tag = HOU
				tag = KUR
				tag = PUK
				tag = ROJ
			}
			check_variable = { internal_radicalization > 19 }
		}
		add_ideas = youth_radicalization
	}
	else = {
		remove_ideas = youth_radicalization
	}

	clamp_variable = { var = internal_radicalization min = 0 max = 100 }
	missile_ui_update = yes
}

calculate_radicalization = {
	#Adjust nations radicalization growth
	#Major sweeping checks here, for government popularity / war support, ect
	#Events can just modify the variable directly

	if = {
		limit = {
			OR = {
				AND = {
					has_elections = no
					check_variable = { government_coalition_strength < 0.15 }
					has_stability < 0.45
				}
				AND = {
					check_variable = { government_coalition_strength < 0.45 }
					has_stability < 0.35
				}
			}
		}
		set_temp_variable_to_random = {
			var = rad_add
			min = 0.5
			max = 2
		}
		add_to_temp_variable = { full_rad_add = rad_add }
	}else_if = {
		limit = {
			check_variable = { government_coalition_strength > 0.5 }
			has_stability > 0.45
		}
		set_temp_variable_to_random = {
			var = rad_add
			min = -0.5
			max = -2
		}
		add_to_temp_variable = { full_rad_add = rad_add }
	}

	if = {
		limit = {
			has_war = no
		}
		set_temp_variable_to_random = {
			var = rad_add
			min = -0.5
			max = -1
		}
		add_to_temp_variable = { full_rad_add = rad_add }
	}else = {
		if = {
			limit = {
				has_war_support < 0.3
			}
			set_temp_variable_to_random = {
				var = rad_add
				min = 0.5
				max = 1
			}
			add_to_temp_variable = { full_rad_add = rad_add }
		}
	}

	multiply_temp_variable = { rad_add = internal_rad_mod }
	add_to_variable = { internal_radicalization = full_rad_add }

	clamp_radicalization = yes
}

social_conservatism_adjust = {
	#First, calculate how radical our people will potentially be this cycle
	#For optimal math, we do this *before* we adjust the numbers
	set_temp_variable = { social_conservatism_government_track = social_conservatism_government }
	subtract_from_temp_variable = { social_conservatism_government_track = social_conservatism_society }
	if = {
		limit = {
			check_variable = { social_conservatism_government_track < 0 }
		}
		multiply_temp_variable = { social_conservatism_government_track = -1 }
	}
	#Add the base value of 50, then clamp it between the min / max range before it goes into the random
	add_to_temp_variable = { social_conservatism_government_track = 50 }
	clamp_temp_variable = {
		var = social_conservatism_government_track
		min = 0
		max = 100
	}

	if = {
		limit = {
			check_variable = { social_conservatism_government < social_conservatism_society }
		}
		subtract_from_variable = { social_conservatism_society = 1 }
		clamp_variable = { var = social_conservatism_society min = social_conservatism_government max = 100 }

		random = {
			chance = social_conservatism_government_track
			country_event = { id = radicalization.1 random_hours = 24 }
		}
	}else = {
		add_to_variable = { social_conservatism_society = 1 }
		clamp_variable = { var = social_conservatism_society min = 0 max = social_conservatism_government }

		random = {
			chance = social_conservatism_government_track
			country_event = { id = radicalization.2 random_hours = 24 }
		}
	}

	update_social_conservatism_idea = yes
}