# Author(s): Simone, AngriestBird
# -------------
# Adjuster Variables
# The following variable is used to adjust the balance of all consumption without adjusting the ratio of the sources
@energy_use_balance_multiplier = 1.25
# The following variable is used to adjust the balance of the Population Energy Consumption
@population_energy_use_balance_value = 28

# Effect: calculate_energy_use
# Purpose: Calculates the Energy Use of a nation for the Energy System
calculate_energy_use = {
	# Add the Dynamic Modifiers for the System in case they are not present
	if = { limit = { NOT = { has_dynamic_modifier = { modifier = energy_dynamic_modifier } } } add_dynamic_modifier = { modifier = energy_dynamic_modifier } }
	if = { limit = { NOT = { has_dynamic_modifier = { modifier = no_fuel_penalties_modifier } } } add_dynamic_modifier = { modifier = no_fuel_penalties_modifier } }

	#set temp vars for each multiplier and add 1 to the multipliers (which are percentages).
	#IE: if energy_use_multiplier is modified to 40% (.4) it will be treated as a 140% (1.4) multiplication on its correlating modifier
	# Energy Use Multiplier
	set_temp_variable = { temp_pop_use_m = 1 }
	add_to_temp_variable = { temp_pop_use_m = modifier@pop_energy_use_multiplier }
	set_temp_variable = { temp_energy_use_m = 1 }
	add_to_temp_variable = { temp_energy_use_m = modifier@energy_use_multiplier }
	# Energy Gain Multiplier
	set_temp_variable = { temp_energy_gain_m = 1 }
	add_to_temp_variable = { temp_energy_gain_m = modifier@energy_gain_multiplier }

	# Energy Consumption Calculations #
	# --------------------------------#
	# Population Energy Use Calculation
	# Base formula: population_total * 0.001 * temp_pop_use_m * gdp_per_capita * 0.025 * @population_energy_use_balance_value
	set_temp_variable = { population_energy_use = population_total }
	multiply_temp_variable = { population_energy_use = 0.001 }
	multiply_temp_variable = { population_energy_use = temp_pop_use_m }

	# GDP/c scaling factor (40k GDP/c is considered the middle ground)
	set_temp_variable = { temp_gdp_per_capita = gdp_per_capita }
	clamp_temp_variable = { var = temp_gdp_per_capita min = 1 }
	multiply_temp_variable = { temp_gdp_per_capita = 0.025 }
	multiply_temp_variable = { population_energy_use = temp_gdp_per_capita }

	# Balance multiplier to adjust population consumption relative to other sources
	multiply_temp_variable = { population_energy_use = @population_energy_use_balance_value }

	# Add energy_use (static use from special decisions/events)
	set_temp_variable = { other_energy_use = modifier@energy_use }

	# Energy Use from Buildings
	# Building base energy use constants (will be factored into unified multipliers)
	# Civs: 0.5, Offices: 0.25, Agriculture: 0.10, Mils: 0.5
	# Microchip: 0.75, Composite: 0.8, Synthetic Refinery: 0.2

	# Build unified multipliers incorporating base energy use values
	# Format: (1 + modifier) * base_energy_use
	set_temp_variable = { energy_use_multiplier_synthetic_refinery = 1 }
	add_to_temp_variable = { energy_use_multiplier_synthetic_refinery = modifier@energy_use_modifier_synthetic_refinery }
	multiply_temp_variable = { energy_use_multiplier_synthetic_refinery = 0.2 }

	set_temp_variable = { energy_use_multiplier_composite_plant = 1 }
	add_to_temp_variable = { energy_use_multiplier_composite_plant = modifier@energy_use_modifier_composite_plants }
	multiply_temp_variable = { energy_use_multiplier_composite_plant = 0.8 }

	set_temp_variable = { energy_use_multiplier_microchip_plant = 1 }
	add_to_temp_variable = { energy_use_multiplier_microchip_plant = modifier@energy_use_modifier_microchip_plants }
	multiply_temp_variable = { energy_use_multiplier_microchip_plant = 0.75 }

	set_temp_variable = { energy_use_multiplier_civs = 1 }
	add_to_temp_variable = { energy_use_multiplier_civs = modifier@energy_use_modifier_civs }
	multiply_temp_variable = { energy_use_multiplier_civs = 0.5 }

	set_temp_variable = { energy_use_multiplier_offices = 1 }
	add_to_temp_variable = { energy_use_multiplier_offices = modifier@energy_use_modifier_offices }
	multiply_temp_variable = { energy_use_multiplier_offices = 0.25 }

	set_temp_variable = { energy_use_multiplier_agriculture_district = 1 }
	add_to_temp_variable = { energy_use_multiplier_agriculture_district = modifier@energy_use_modifier_agriculture_district }
	multiply_temp_variable = { energy_use_multiplier_agriculture_district = 0.10 }

	set_temp_variable = { energy_use_multiplier_mils = 1 }
	add_to_temp_variable = { energy_use_multiplier_mils = modifier@energy_use_modifier_mils }
	multiply_temp_variable = { energy_use_multiplier_mils = 0.5 }

	# Apply unified multipliers to building counts
	set_temp_variable = { energy_use_synthetic_refinery = synthetic_refinery_total }
	multiply_temp_variable = { energy_use_synthetic_refinery = energy_use_multiplier_synthetic_refinery }

	set_temp_variable = { energy_use_composite_plants = composite_plant_total }
	multiply_temp_variable = { energy_use_composite_plants = energy_use_multiplier_composite_plant }

	set_temp_variable = { energy_use_microchip_plants = microchip_plant_total }
	multiply_temp_variable = { energy_use_microchip_plants = energy_use_multiplier_microchip_plant }

	set_temp_variable = { energy_use_civs = industrial_complex_total }
	multiply_temp_variable = { energy_use_civs = energy_use_multiplier_civs }

	set_temp_variable = { energy_use_offices = office_park_total }
	multiply_temp_variable = { energy_use_offices = energy_use_multiplier_offices }

	set_temp_variable = { energy_use_agriculture_district = agriculture_district_total }
	multiply_temp_variable = { energy_use_agriculture_district = energy_use_multiplier_agriculture_district }

	set_temp_variable = { energy_use_mils = military_fac }
	add_to_temp_variable = { energy_use_mils = num_of_naval_factories }
	multiply_temp_variable = { energy_use_mils = energy_use_multiplier_mils }

	set_temp_variable = { energy_use_buildings = energy_use_civs }
	add_to_temp_variable = { energy_use_buildings = energy_use_offices }
	add_to_temp_variable = { energy_use_buildings = energy_use_agriculture_district }
	add_to_temp_variable = { energy_use_buildings = energy_use_mils }
	add_to_temp_variable = { energy_use_buildings = energy_use_microchip_plants }
	add_to_temp_variable = { energy_use_buildings = energy_use_composite_plants }
	add_to_temp_variable = { energy_use_buildings = energy_use_synthetic_refinery }

	# Additive Section of All Internal Sources of Energy Consumption
	set_temp_variable = { temp_total_energy_use = population_energy_use }
	add_to_temp_variable = { temp_total_energy_use = energy_use_buildings }
	add_to_temp_variable = { temp_total_energy_use = other_energy_use }

	# Factor the entire thing by its multiplier to get final energy use
	multiply_temp_variable = { temp_total_energy_use = temp_energy_use_m }

	# Balance multiplier, modify this if you want to tweak overall energy consumption without touching the ratio of its sources
	multiply_temp_variable = { temp_total_energy_use = @energy_use_balance_multiplier }
	clamp_temp_variable = { var = temp_total_energy_use min = 0.001 }

	# Modify Display Variables
	# Consolidate display multiplier: temp_energy_use_m * @energy_use_balance_multiplier
	set_temp_variable = { display_multiplier = temp_energy_use_m }
	multiply_temp_variable = { display_multiplier = @energy_use_balance_multiplier }

	multiply_temp_variable = { population_energy_use = display_multiplier }
	multiply_temp_variable = { energy_use_buildings = display_multiplier }
	multiply_temp_variable = { other_energy_use = display_multiplier }
	multiply_temp_variable = { energy_use_civs = display_multiplier }
	multiply_temp_variable = { energy_use_offices = display_multiplier }
	multiply_temp_variable = { energy_use_agriculture_district = display_multiplier }
	multiply_temp_variable = { energy_use_mils = display_multiplier }
	multiply_temp_variable = { energy_use_microchip_plants = display_multiplier }
	multiply_temp_variable = { energy_use_composite_plants = display_multiplier }
	multiply_temp_variable = { energy_use_synthetic_refinery = display_multiplier }

	# Display Variables for the Energy Consumption per Type
	set_variable = { population_energy_use_display_var = population_energy_use }
	set_variable = { energy_use_buildings_total_display_var = energy_use_buildings }
	set_variable = { other_energy_use_display_var = other_energy_use }
	set_variable = { energy_use_civs_total_display_var = energy_use_civs }
	set_variable = { energy_use_offices_total_display_var = energy_use_offices }
	set_variable = { energy_use_agriculture_district_total_display_var = energy_use_agriculture_district }
	set_variable = { energy_use_mils_total_display_var = energy_use_mils }
	set_variable = { energy_use_microchip_plants_total_display_var = energy_use_microchip_plants }
	set_variable = { energy_use_composite_plants_total_display_var = energy_use_composite_plants }
	set_variable = { energy_use_synthetic_refinery_total_display_var = energy_use_synthetic_refinery }

	# Net Energy Balance Calculations
	# Add energy gain to sum, then factor it by corresponding multiplier to get final energy gain (through modifiers)
	set_variable = { energy_sum = state_renewable_energy_var }
	set_temp_variable = { temp_renewable_energy_gain_m = 1 }
	add_to_temp_variable = { temp_renewable_energy_gain_m = modifier@renewable_energy_gain_multiplier }
	multiply_temp_variable = { temp_renewable_energy_gain_m = temp_energy_gain_m }

	multiply_variable = { energy_sum = temp_renewable_energy_gain_m }
	multiply_variable = { minimum_renewable_energy_var = temp_renewable_energy_gain_m }
	multiply_variable = { maximum_renewable_energy_var = temp_renewable_energy_gain_m }

	set_variable = { renewable_energy_display_var = energy_sum }

	set_temp_variable = { battery_stored_energy = number_of_battery_parks }
	# Base Amount of GW/h One Battery Park Can Store
	multiply_temp_variable = { battery_stored_energy = 100 }
	set_temp_variable = { battery_stored_energy_modifier = 1 }
	add_to_temp_variable = { battery_stored_energy_modifier = modifier@battery_park_storage_size_modifier }
	multiply_temp_variable = { battery_stored_energy = battery_stored_energy_modifier }
	add_to_variable = { max_stored_energy = battery_stored_energy }

	multiply_variable = { hydroelectric_energy_generation = temp_energy_gain_m }
	multiply_variable = { geothermal_energy_generation = temp_energy_gain_m }
	add_to_variable = { energy_sum = hydroelectric_energy_generation }
	add_to_variable = { energy_sum = geothermal_energy_generation }

	# Calculate fuel consumption and energy generation of fossil power plants
	if = { limit = { has_country_flag = disable_fossil_fuel_power_plant_flag }
		set_variable = { fossil_pp_energy_generation = 0 }
		set_variable = { fossil_pp_fuel_consumption = 0 }
	}
	else = {
		set_variable = { fossil_pp_energy_generation = modifier@fossil_energy_gain }
		set_temp_variable = { fossil_pp_energy_generation_multiplier = 1 }
		add_to_temp_variable = { fossil_pp_energy_generation_multiplier = modifier@fossil_pp_energy_generation_modifier }
		multiply_variable = { fossil_pp_energy_generation = fossil_pp_energy_generation_multiplier }
		multiply_variable = { fossil_pp_energy_generation = temp_energy_gain_m }

		set_variable = { fossil_pp_fuel_consumption = modifier@fossil_fuel_consumption }
		set_temp_variable = { fossil_pp_fuel_consumption_multiplier = 1 }
		add_to_temp_variable = { fossil_pp_fuel_consumption_multiplier = modifier@fossil_pp_fuel_consumption_modifier }
		multiply_variable = { fossil_pp_fuel_consumption = fossil_pp_fuel_consumption_multiplier }
		multiply_variable = { fossil_pp_fuel_consumption = -1 }

		# Generation of Power per Fossil Power Plant
		set_variable = { fossil_pp_energy_per_plant_display = 1 }
		multiply_variable = { fossil_pp_energy_per_plant_display = fossil_pp_energy_generation_multiplier }
		multiply_variable = { fossil_pp_energy_per_plant_display = temp_energy_gain_m }
	}

	# Implements the No Fuel Killswitch
	set_temp_variable = { no_fuel_killswitch_var = 1 }
	if = { limit = { check_variable = { fuel_k = 0 } }
		set_variable = { fossil_pp_energy_generation = 0 }
		set_variable = { fossil_pp_fuel_consumption = 0 }
		set_temp_variable = { no_fuel_killswitch_var = 0 }
	}
	add_to_variable = { energy_sum = fossil_pp_energy_generation }

	# Nuclear Energy Section
	if = { limit = { has_country_flag = enabled_nuclear_reactor_fuel_production }
		set_temp_variable = { base_nuclear_reactor_fuel_production = 200 } # CHANGE ME IF YOU WANT ME TO BE MORE PRODUCTIVE, weekly production value

		set_temp_variable = { modify_leu = 1 }
		add_to_temp_variable = { modify_leu = modifier@nuclear_reactor_fuel_production }

		multiply_temp_variable = { base_nuclear_reactor_fuel_production = modify_leu }
		round_variable = base_nuclear_reactor_fuel_production

		set_temp_variable = { temp1 = base_nuclear_reactor_fuel_production }
		multiply_temp_variable = { temp1 = enrichment_facilities }
		set_variable = { nuclear_reactor_fuel_production = temp1 }
	}
	else = {
		set_variable = { nuclear_reactor_fuel_production = 0 }
	}

	if = {
		limit = {
			NOT = { has_country_flag = disable_nuclear_power_plant_flag }
			OR = {
				has_idea = nuclear_energy
				has_idea = nuclear_power_off
				has_idea = nuclear_power_def
			}
		}
		set_variable = { nuclear_fuel_consumption = modifier@nuclear_fuel_consumption }
		set_temp_variable = { nuclear_fuel_consumption_multiplier = 1 }
		add_to_temp_variable = { nuclear_fuel_consumption_multiplier = modifier@nuclear_fuel_consumption_modifier }
		multiply_variable = { nuclear_fuel_consumption = nuclear_fuel_consumption_multiplier }
		clamp_variable = { var = nuclear_fuel_consumption min = 0.0001 }

		set_variable = { net_nuclear_fuel_display = nuclear_reactor_fuel_production }
		subtract_from_variable = { net_nuclear_fuel_display = nuclear_fuel_consumption }

		set_variable = { nuclear_energy_generation = modifier@nuclear_energy_gain }
		set_temp_variable = { nuclear_energy_generation_multiplier = 1 }
		add_to_temp_variable = { nuclear_energy_generation_multiplier = modifier@nuclear_energy_generation_modifier }
		multiply_variable = { nuclear_energy_generation = nuclear_energy_generation_multiplier }

		if = { limit = { check_variable = { var_reactor_material_stockpile = 0 } }
			set_temp_variable = { nuclear_fuel_fulfillment = nuclear_reactor_fuel_production }
			divide_temp_variable = { nuclear_fuel_fulfillment = nuclear_fuel_consumption }
			clamp_temp_variable = { var = nuclear_fuel_fulfillment min = 0 max = 1 }
			multiply_variable = { nuclear_energy_generation = nuclear_fuel_fulfillment }
		}

		multiply_variable = { nuclear_energy_generation = temp_energy_gain_m }
		add_to_variable = { energy_sum = nuclear_energy_generation }

		# Generation of Power per Fossil Power Plant
		set_variable = { nuclear_energy_per_reactor_display = 2 }
		multiply_variable = { nuclear_energy_per_reactor_display = nuclear_energy_generation_multiplier }
		multiply_variable = { nuclear_energy_per_reactor_display = temp_energy_gain_m }
	}
	else = {
		set_variable = { nuclear_fuel_consumption = 0 }
		set_variable = { nuclear_energy_generation = 0 }

		# Set only to production when nuclear power is disabled
		set_variable = { net_nuclear_fuel_display = nuclear_reactor_fuel_production }
	}

	# Flat Miscellaneous Gain from Content
	set_variable = { other_energy_generation = modifier@energy_gain }
	multiply_variable = { other_energy_generation = temp_energy_gain_m }
	add_to_variable = { energy_sum = other_energy_generation }

	set_variable = { energy_consumption = temp_total_energy_use }
	set_variable = { energy_balance = energy_sum }
	subtract_from_variable = { energy_balance = energy_consumption }

	set_temp_variable = { energy_fulfillment = energy_sum }
	set_variable = { energy_withdrawal_from_storage = 0 }
	set_variable = { free_fossil_powerplants_power = 0 }
	if = {
		limit = {
			check_variable = { stored_energy > 0 }
			check_variable = { energy_balance < 0 }
		}
		set_variable = { energy_withdrawal_from_storage = energy_balance }
		multiply_variable = { energy_withdrawal_from_storage = -1 }
		add_to_temp_variable = { energy_fulfillment = energy_withdrawal_from_storage }
	}
	if = {
		limit = {
			check_variable = { stored_energy = max_stored_energy }
			check_variable = { energy_balance > 0 }
			check_variable = { fossil_pp_fuel_consumption < 0 }
		}
		set_temp_variable = { saved_fuel = energy_balance }
		clamp_temp_variable = {
			var = saved_fuel
			max = fossil_pp_energy_generation
			min = 0
		}
		set_variable = { free_fossil_powerplants_power = saved_fuel }
		subtract_from_variable = { fossil_pp_energy_generation = saved_fuel }
		subtract_from_variable = { energy_sum = saved_fuel }
		multiply_temp_variable = { saved_fuel = 20 } #base fossil powerplant fuel consumption, found in buildings.txt, positive sicne its saved fuel instead of consumed
		multiply_temp_variable = { saved_fuel = fossil_pp_fuel_consumption_multiplier }
		divide_temp_variable = { saved_fuel = fossil_pp_energy_generation_multiplier }
		add_to_variable = { fossil_pp_fuel_consumption = saved_fuel }
	}

	divide_temp_variable = { energy_fulfillment = energy_consumption }
	set_variable = { energy_balance_value_display = energy_fulfillment }
	clamp_variable = { var = energy_balance_value_display min = 0 }
	clamp_temp_variable = { var = energy_fulfillment min = 0 max = 1 }
	set_variable = { unfulfilled_energy_demand_var = -1 }
	add_to_variable = { unfulfilled_energy_demand_var = energy_fulfillment }
	add_to_variable = { energy_sum = energy_withdrawal_from_storage } #for display purposes

	set_variable = { energy_difference_variable = energy_sum }
	subtract_from_variable = { energy_difference_variable = energy_consumption }
	if = { limit = { has_variable = energy_load_sharing_gain_var }
		subtract_from_variable = { energy_difference_variable = energy_load_sharing_gain_var }
	}

	# Caps penalty for unfulfilled at 50%, and multiples 100 to get a whole number to reduce to penalty scale
	set_variable = { unfulfilled_energy_demand_dynmod_var = unfulfilled_energy_demand_var }
	multiply_variable = { unfulfilled_energy_demand_dynmod_var = 0.5 }
	clamp_variable = { var = unfulfilled_energy_demand_dynmod_var min = -0.50 max = 0 }
	set_variable = { unfulfilled_energy_demand_dynmod_var_2 = unfulfilled_energy_demand_dynmod_var }
	multiply_variable = { unfulfilled_energy_demand_dynmod_var_2 = gdp_per_capita }
	multiply_variable = { unfulfilled_energy_demand_dynmod_var_2 = 0.025 } #penalties decrease below 40k gdp/c, increase above it
	clamp_variable = { var = unfulfilled_energy_demand_dynmod_var_2 min = -0.50 max = 0 }
	set_variable = { unfulfilled_energy_demand_dynmod_var_3 = unfulfilled_energy_demand_var }
	multiply_variable = { unfulfilled_energy_demand_dynmod_var_3 = 0.3 }
	clamp_variable = { var = unfulfilled_energy_demand_dynmod_var_3 min = -0.30 max = 0 }

	# Calculate the Non-Electric Fuel Consumption
	set_variable = { non_electric_fuel_consumption = population_total_m }
	multiply_variable = { non_electric_fuel_consumption = -19 }
	set_temp_variable = { gdpc_scaling_multiplier = gdp_per_capita }
	multiply_temp_variable = { gdpc_scaling_multiplier = 0.02 } #division by 50, random number but feels right
	add_to_temp_variable = { gdpc_scaling_multiplier = 0.1 } #could be another number, maybe one, just sets the base cost for super low GDP/c countries
	multiply_variable = { non_electric_fuel_consumption = gdpc_scaling_multiplier }
	set_temp_variable = { non_electric_fuel_consumption_multiplier = 1 }
	add_to_temp_variable = { non_electric_fuel_consumption_multiplier = modifier@non_electric_fuel_consumption_modifier }
	clamp_temp_variable = { var = non_electric_fuel_consumption_multiplier min = 0 }
	multiply_variable = { non_electric_fuel_consumption = non_electric_fuel_consumption_multiplier }
	multiply_variable = { non_electric_fuel_consumption = no_fuel_killswitch_var }
	set_variable = { powerplants_and_pop_fuel_consumption = non_electric_fuel_consumption }
	add_to_variable = { powerplants_and_pop_fuel_consumption = fossil_pp_fuel_consumption }

	# Calculate the Display Variables
	set_variable = { fossil_pp_fuel_display = fossil_pp_fuel_consumption }
	multiply_variable = { fossil_pp_fuel_display = 24 }

	set_variable = { non_electric_fuel_display = non_electric_fuel_consumption }
	multiply_variable = { non_electric_fuel_display = 24 }

	force_update_dynamic_modifier = yes
	add_to_variable = { global.energy_ui = 1 }
}

# Effect: calculate_energy_load_sharing
# Purpose: Calculates the Energy Load Sharing
# TODO: This right now is limited to one way agreements for now. We can expand this to more bilateral agreements later on when we have more details on it.
calculate_energy_load_sharing = {
	if = { limit = { NOT = { check_variable = { energy_load_sharing_nations^0 = 0 } } }
		# Reset the amount of energy load shared to 0
		set_variable = { energy_load_sharing_use_var = 0 }
		set_variable = { energy_load_sharing_gain_var = 0 }
		set_temp_variable = { needed_energy_for_nations = 0 }
		for_each_scope_loop = {
			array = energy_load_sharing_nations
			if = { limit = { check_variable = { energy_difference_variable < 0 } }
				add_to_temp_variable = { PREV.needed_energy_for_nations = energy_difference_variable }
			}
		}

		# Calculate the Energy Shared
		# Assume that if you are sharing energy that you have to maintain more energy otherwise the loading sharing has gotta stop
		if = { limit = { check_variable = { energy_difference_variable > needed_energy_for_nations } }
			resize_array = { array = energy_load_sharing_nations_value size = energy_load_sharing_nations^num }

			for_each_loop = {
				array = energy_load_sharing_nations
				var:v = {
					set_temp_variable = { energy_lack = energy_difference_variable }
					set_variable = { PREV.energy_load_sharing_nations_value^i = energy_lack }
					set_variable = { energy_load_sharing_gain_var = energy_lack }
					multiply_variable = { energy_load_sharing_gain_var = -1 }
					force_update_dynamic_modifier = yes
				}
			}
			set_temp_variable = { total_energy_required_to_share = 0 }
			for_each_loop = {
				array = energy_load_sharing_nations_value
				add_to_temp_variable = { PREV.total_energy_required_to_share = v }
			}
			set_variable = { energy_load_sharing_use_var = total_energy_required_to_share }
			multiply_variable = { energy_load_sharing_use_var = -1 }
		}
		else = {
			# Provider doesn't have enough energy to share
			set_variable = { energy_load_sharing_use_var = 0 }
			for_each_loop = {
				array = energy_load_sharing_nations
				var:v = {
					set_variable = { energy_load_sharing_gain_var = 0 }
					force_update_dynamic_modifier = yes
				}
			}
		}
		force_update_dynamic_modifier = yes
	}
	# Clear variables if you're neither a provider nor a recipient
	if = {
		limit = {
			check_variable = { energy_load_sharing_nations^0 = 0 }
			NOT = { has_country_flag = energy_load_sharing_recipient }
		}
		clear_variable = energy_load_sharing_use_var
		clear_variable = energy_load_sharing_gain_var
		clear_variable = energy_load_sharing_income_var
	}
}

# Effect: energy_on_daily
# Purpose: applies the energy balance penalties
energy_on_daily = {
	set_variable = { no_fuel_penalties_var = 0 }
	if = { limit = { check_variable = { fuel_k = 0 } }
		set_variable = { no_fuel_penalties_var = -0.5 }
		ingame_update_setup = yes
	}
	set_temp_variable = { daily_energy_balance = energy_balance }
	multiply_temp_variable = { daily_energy_balance = 24 } #gw to gwh
	add_to_variable = { stored_energy = daily_energy_balance }

	if = { limit = { check_variable = { ROOT.max_stored_energy = 0 } }
		set_temp_variable = { temp_maximum = 1 }
	}
	else = {
		set_temp_variable = { temp_maximum = ROOT.max_stored_energy }
	}

	clamp_variable = { var = ROOT.stored_energy min = 0 max = temp_maximum }
}

# Effect: random_renewable_variable_calculation
# Purpose: Calculates the randomized variable for the amount of energy gained from Renewable Energy from a specific state
random_renewable_variable_calculation = {
	for_each_scope_loop = {
		array = global.states
		set_variable_to_random = { var = renewable_energy_random_var min = modifier@state_renewable_capacity_factor_modifier max = 1 }
		# Calculate the Min / Max
		set_variable = { min_renewable_energy_var = modifier@state_renewable_capacity_factor_modifier }
		set_variable = { max_renewable_energy_var = 1 }
		add_to_variable = { max_renewable_energy_var = modifier@state_renewable_capacity_factor_modifier }
	}
}

# Effect: setup_starting_fossil_powerplants
# Purpose: Sets the onstartup energy required for all nations without manually setting every fossil fuel power plant
setup_starting_fossil_powerplants = {
	set_variable = { startup_energy_needed = energy_consumption } #startup_energy_needed will be the number of needed fossil power plants
	subtract_from_variable = { startup_energy_needed = energy_sum }
	round_variable = startup_energy_needed
	clamp_variable = { var = startup_energy_needed min = 1 } #so every country, even the smallest ones, start with 1 fossil fuel power plant
	while_loop_effect = {
		limit = {
			check_variable = { startup_energy_needed > 0 }
		}
		random_owned_controlled_state = {
			add_building_construction = {
				type = fossil_powerplant
				level = 1
				instant_build = yes
			}
		}
		add_to_variable = { startup_energy_needed = -1 }
	}
	clear_variable = startup_energy_needed
}

build_fossil_fuel_power_plant_effect = {
	custom_effect_tooltip = energy_build_fossil_powerplant_TT
	if = {
		limit = {
			check_variable = { temp_change > 0 }
		}
		set_temp_variable = { treasury_change = temp_change }
		if = { limit = { is_ai = no }
			multiply_temp_variable = { treasury_change = -5 }
		}
		else = {
			multiply_temp_variable = { treasury_change = -2 }
		}
		modify_treasury_effect = yes
		random_owned_controlled_state = {
			limit = {
				NOT = {
					has_state_flag = building_fossil_fuel_powerplant
				}
			}
			custom_effect_tooltip = building_fossil_fuel_powerplant_tt
			set_state_flag = {
				flag = building_fossil_fuel_powerplant
				days = 100
				value = 1
			}
		}
	}
	else = {
		random_owned_controlled_state = {
			limit = {
				check_variable = { number_of_fossil_pps_state_var > 0 }
			}
			add_to_variable = { number_of_fossil_pps_state_var = temp_change }
		}
	}
	ingame_update_setup = yes
}

build_battery_park_effect = {
	custom_effect_tooltip = build_battery_park_effect_TT
	set_temp_variable = { battery_cost_multiplier = modifier@battery_park_construction_cost }
	add_to_temp_variable = { battery_cost_multiplier = 1 }
	set_temp_variable = { treasury_change = temp_change }
	multiply_temp_variable = { treasury_change = -100 } #starts at 1000$/kwh in 2000, goes down to 100$/kwh with techs
	multiply_temp_variable = { treasury_change = battery_cost_multiplier }
	modify_treasury_effect = yes
	hidden_effect = {
		random_owned_controlled_state = {
			add_to_variable = { number_of_battery_parks_state_var = temp_change }
		}
	}
	ingame_update_setup = yes
}

build_enrichment_facilities_effect = {
	custom_effect_tooltip = build_enrichment_facilities_effect_tt
	add_to_variable = { enrichment_facilities = temp_change }
	ingame_update_setup = yes

	if = { limit = { check_variable = { temp_change > 0 } }
		set_temp_variable = { treasury_change = temp_change }
		multiply_temp_variable = { treasury_change = -25 }
		modify_treasury_effect = yes
	}

	if = { limit = { NOT = { is_in_array = { global.enrichment_countries = THIS.id } } }
		add_to_array = { global.enrichment_countries = THIS.id }
		if = {
			limit = { NOT = { has_country_flag = enabled_nuclear_reactor_fuel_production } }
			set_country_flag = enabled_nuclear_reactor_fuel_production
		}
	}
}

# Effect: add_hydroelectric_energy_production_effect
# Purpose: Adds hydroelectric energy production to a particular state
# Parameters:
# - electric_addition - Power generation of the plants
# - storage_addition - Storage addition for the plants
add_hydroelectric_energy_production_effect = {
	custom_effect_tooltip = add_hydroelectric_energy_production_effect_tt
	add_to_variable = { hydroelectric_energy_production_var = electric_addition }
	add_to_variable = { hydroelectric_energy_storage_var = storage_addition }

	hidden_effect = {
		if = {
			limit = {
				NOT = { has_dynamic_modifier = { modifier = hydroelectric_infrastructure_in_state } }
			}
			add_dynamic_modifier = {
				modifier = hydroelectric_infrastructure_in_state
			}
		}
	}
}

# Effect: change_reactor_grade_material_effect
# Purpose: Changes the amount of reactor grade nuclear material that a nation possesses
change_reactor_grade_material_effect = {
	custom_effect_tooltip = change_reactor_grade_material_effect_tt
	add_to_variable = { var_reactor_material_stockpile = change_resource }
}

# Effect: buy_fuel_from_the_market_effect
# Purpose: Adds 50k units of fuel when buying it from the energy screen
buy_fuel_from_the_market_effect = {
	add_fuel = 50000
	set_temp_variable = { treasury_change = -0.1 }
	modify_treasury_effect = yes
}
